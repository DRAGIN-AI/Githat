<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat - Multi-Provider Example</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    
    <!--  Include our custom classes -->
    <script src="./db.js"></script>
    <script src="./providers-config.js"></script>
    <script src="./provider.js"></script>
    <script src="./chat.js"></script>
    <script src="./project.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6">AI Chat - Multi-Provider Integration</h1>
        
        <!-- Provider Management Section -->
        <div class="glass rounded-lg p-6 mb-4">
            <h2 class="text-xl font-semibold mb-4">AI Providers</h2>
            <div id="providersList" class="space-y-3"></div>
            <button onclick="showAddProviderDialog()" class="mt-4 px-4 py-2 bg-blue-500 rounded hover:bg-blue-600">
                + Add Custom Provider
            </button>
        </div>
        
        <!-- Model Selection -->
        <div class="glass rounded-lg p-6 mb-4">
            <h2 class="text-xl font-semibold mb-4">Select Model</h2>
            <select id="modelSelect" class="w-full bg-white/10 border border-white/20 rounded px-3 py-2">
                <option>Loading...</option>
            </select>
        </div>
        
        <!-- Chat Area -->
        <div class="glass rounded-lg p-6 mb-4">
            <h2 class="text-xl font-semibold mb-4">Chat</h2>
            <div id="chatMessages" class="space-y-3 mb-4 min-h-[200px]"></div>
            <div class="flex gap-2">
                <input id="messageInput" type="text" placeholder="Type your message..." 
                       class="flex-1 bg-white/10 border border-white/20 rounded px-3 py-2"
                       onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" class="px-4 py-2 bg-blue-500 rounded hover:bg-blue-600">
                    Send
                </button>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="glass rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Statistics</h2>
            <div id="stats"></div>
        </div>
    </div>

    <!-- Modal for adding provider -->
    <div id="providerModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4">
        <div class="glass rounded-lg p-6 max-w-md w-full">
            <h2 class="text-xl font-semibold mb-4">Add Custom Provider</h2>
            <form onsubmit="saveCustomProvider(event)" class="space-y-3">
                <input name="name" placeholder="Provider Name" required 
                       class="w-full bg-white/10 border border-white/20 rounded px-3 py-2">
                <input name="baseUrl" placeholder="API Base URL (e.g., https://api.example.com/v1)" required 
                       class="w-full bg-white/10 border border-white/20 rounded px-3 py-2">
                <input name="apiKey" type="password" placeholder="API Key (optional)" 
                       class="w-full bg-white/10 border border-white/20 rounded px-3 py-2">
                <select name="requestFormat" class="w-full bg-white/10 border border-white/20 rounded px-3 py-2">
                    <option value="openai">OpenAI Compatible</option>
                    <option value="anthropic">Anthropic/Claude</option>
                    <option value="google">Google/Gemini</option>
                </select>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 px-4 py-2 bg-blue-500 rounded hover:bg-blue-600">
                        Save
                    </button>
                    <button type="button" onclick="hideAddProviderDialog()" 
                            class="px-4 py-2 bg-gray-500 rounded hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global managers
        let db, providerManager, chatManager, projectManager;
        let isTyping = false;

        // Initialize the application
        async function initializeApp() {
            try {
                // Initialize database
                db = new DatabaseManager();
                await db.init();
                
                // Initialize managers
                providerManager = new ProviderManager(db);
                await providerManager.init();
                
                chatManager = new ChatManager(db);
                await chatManager.init();
                
                projectManager = new ProjectManager(db);
                await projectManager.init();
                
                // Render UI
                renderProviders();
                renderModelSelector();
                renderChat();
                renderStats();
                
                console.log('âœ“ App initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Failed to initialize app: ' + error.message);
            }
        }

        // Render providers list
        function renderProviders() {
            const providers = providerManager.getAllProviders();
            const html = providers.map(provider => `
                <div class="bg-white/5 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-xl" 
                                 style="background: ${provider.color}">
                                ${provider.name[0]}
                            </div>
                            <div>
                                <h3 class="font-semibold">${provider.name}</h3>
                                <p class="text-sm opacity-70">${provider.models.length} models</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" 
                                   ${provider.enabled ? 'checked' : ''}
                                   onchange="toggleProvider('${provider.id}', this.checked)"
                                   class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 peer-checked:bg-blue-600 rounded-full peer-focus:ring-2 peer-focus:ring-blue-300 transition-all"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-all peer-checked:translate-x-5"></div>
                        </label>
                    </div>
                    ${provider.apiKeyRequired ? `
                        <input type="password" 
                               value="${provider.apiKey || ''}"
                               placeholder="Enter API Key"
                               onchange="updateProviderKey('${provider.id}', this.value)"
                               class="mt-3 w-full bg-white/10 border border-white/20 rounded px-3 py-2 text-sm">
                    ` : ''}
                    <div class="mt-2 text-xs opacity-50">${provider.baseUrl}</div>
                </div>
            `).join('');
            
            document.getElementById('providersList').innerHTML = html;
        }

        // Toggle provider enabled state
        async function toggleProvider(providerId, enabled) {
            try {
                await providerManager.updateProvider(providerId, { enabled });
                renderModelSelector();
                console.log(`Provider ${providerId} ${enabled ? 'enabled' : 'disabled'}`);
            } catch (error) {
                console.error('Error toggling provider:', error);
                alert('Failed to toggle provider: ' + error.message);
                renderProviders(); // Reset UI
            }
        }

        // Update provider API key
        async function updateProviderKey(providerId, apiKey) {
            try {
                await providerManager.updateProvider(providerId, { apiKey });
                console.log(`API key updated for ${providerId}`);
            } catch (error) {
                console.error('Error updating API key:', error);
                alert('Failed to update API key: ' + error.message);
            }
        }

        // Render model selector
        function renderModelSelector() {
            const models = providerManager.getAllModels();
            const activeProvider = providerManager.getActiveProvider();
            
            if (models.length === 0) {
                document.getElementById('modelSelect').innerHTML = 
                    '<option>No models available - enable a provider first</option>';
                return;
            }
            
            const html = models.map(model => `
                <option value="${model.fullId}">
                    ${model.providerName}: ${model.name}
                </option>
            `).join('');
            
            document.getElementById('modelSelect').innerHTML = html;
        }

        // Send message
        async function sendMessage() {
            if (isTyping) return;
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            // Clear input
            input.value = '';
            
            // Get current chat
            const chat = chatManager.getCurrentChat();
            const modelSelect = document.getElementById('modelSelect');
            const selectedModel = modelSelect.value;
            
            // Parse model to get provider
            const { provider, modelId } = providerManager.parseModelId(selectedModel);
            
            if (!provider) {
                alert('No provider selected or provider not found');
                return;
            }
            
            if (!provider.enabled) {
                alert('Selected provider is not enabled');
                return;
            }
            
            if (provider.apiKeyRequired && !provider.apiKey) {
                alert(`Please enter API key for ${provider.name}`);
                return;
            }
            
            // Add user message
            chat.addMessage('user', message);
            await chatManager.updateChat(chat.id, chat.toJSON());
            renderChat();
            
            // Send request
            isTyping = true;
            let assistantMessage = '';
            
            try {
                // Add placeholder for assistant message
                chat.addMessage('assistant', '');
                renderChat();
                
                const messages = chat.getMessagesForAPI();
                const response = await provider.sendRequest(messages, modelId, {
                    stream: true,
                    temperature: chat.temperature
                });
                
                // Stream response
                for await (const chunk of provider.streamResponse(response)) {
                    assistantMessage += chunk;
                    chat.messages[chat.messages.length - 1].content = assistantMessage;
                    renderChat();
                }
                
                // Update chat in database
                await chatManager.updateChat(chat.id, chat.toJSON());
                
            } catch (error) {
                console.error('Error sending message:', error);
                assistantMessage = `Error: ${error.message}`;
                chat.messages[chat.messages.length - 1].content = assistantMessage;
                renderChat();
            } finally {
                isTyping = false;
                renderStats();
            }
        }

        // Render chat messages
        function renderChat() {
            const chat = chatManager.getCurrentChat();
            const html = chat.messages.map(msg => {
                if (msg.role === 'system') return '';
                
                const isUser = msg.role === 'user';
                return `
                    <div class="${isUser ? 'text-right' : 'text-left'}">
                        <div class="inline-block max-w-[80%] rounded-lg p-3 ${
                            isUser ? 'bg-blue-500' : 'bg-white/10'
                        }">
                            <div class="text-xs opacity-70 mb-1">${isUser ? 'You' : 'AI'}</div>
                            <div class="prose prose-invert max-w-none">${
                                marked.parse(msg.content || '...')
                            }</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('chatMessages').innerHTML = html || '<div class="text-center opacity-50">Start a conversation...</div>';
        }

        // Render statistics
        function renderStats() {
            const stats = chatManager.getStatistics();
            const providers = providerManager.getEnabledProviders();
            
            document.getElementById('stats').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-2xl font-bold">${stats.totalChats}</div>
                        <div class="text-sm opacity-70">Total Chats</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold">${stats.totalMessages}</div>
                        <div class="text-sm opacity-70">Total Messages</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold">${providers.length}</div>
                        <div class="text-sm opacity-70">Active Providers</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold">${providerManager.getAllModels().length}</div>
                        <div class="text-sm opacity-70">Available Models</div>
                    </div>
                </div>
            `;
        }

        // Show add provider dialog
        function showAddProviderDialog() {
            document.getElementById('providerModal').classList.remove('hidden');
        }

        // Hide add provider dialog
        function hideAddProviderDialog() {
            document.getElementById('providerModal').classList.add('hidden');
        }

        // Save custom provider
        async function saveCustomProvider(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            try {
                const provider = await providerManager.addProvider({
                    name: formData.get('name'),
                    baseUrl: formData.get('baseUrl'),
                    apiKey: formData.get('apiKey') || '',
                    requestFormat: formData.get('requestFormat'),
                    enabled: false,
                    models: [
                        { id: 'default', name: 'Default Model', contextWindow: 4096 }
                    ]
                });
                
                renderProviders();
                hideAddProviderDialog();
                form.reset();
                
                alert('Custom provider added! You can now configure its models and enable it.');
            } catch (error) {
                console.error('Error adding provider:', error);
                alert('Failed to add provider: ' + error.message);
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
