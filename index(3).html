<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Team Manager - Multi-Agent Collaboration Platform</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 4px; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }

        /* Message styles */
        .message-user {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .message-assistant {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        /* Agent-specific colors */
        .agent-product-owner { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.3); }
        .agent-scrum-master { background: rgba(139, 92, 246, 0.2); border-color: rgba(139, 92, 246, 0.3); }
        .agent-developer { background: rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.3); }
        .agent-devops { background: rgba(245, 158, 11, 0.2); border-color: rgba(245, 158, 11, 0.3); }
        .agent-tester { background: rgba(236, 72, 153, 0.2); border-color: rgba(236, 72, 153, 0.3); }
        .agent-qa { background: rgba(168, 85, 247, 0.2); border-color: rgba(168, 85, 247, 0.3); }
        .agent-architect { background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.3); }

        .agent-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .card.active {
            border-color: rgba(16, 185, 129, 0.6);
            background: rgba(16, 185, 129, 0.1);
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-todo { background: rgba(148, 163, 184, 0.3); color: rgb(203, 213, 225); }
        .status-in-progress { background: rgba(59, 130, 246, 0.3); color: rgb(147, 197, 253); }
        .status-done { background: rgba(16, 185, 129, 0.3); color: rgb(110, 231, 183); }
        .status-blocked { background: rgba(239, 68, 68, 0.3); color: rgb(248, 113, 113); }

        /* Priority badges */
        .priority-low { background: rgba(148, 163, 184, 0.3); color: rgb(203, 213, 225); }
        .priority-medium { background: rgba(251, 191, 36, 0.3); color: rgb(253, 224, 71); }
        .priority-high { background: rgba(239, 68, 68, 0.3); color: rgb(248, 113, 113); }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .modal-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        /* Code blocks */
        .code-block-wrapper {
            position: relative;
            margin: 16px 0;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.3);
        }
        .code-block-header {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Sidebar */
        @media (max-width: 1024px) {
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 50;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            #sidebar.active { transform: translateX(0); }
        }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #34d399);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>
    
    <div class="flex h-screen">
        <!-- Left Sidebar -->
        <div id="sidebar" class="w-80 glass border-r border-white/20 flex flex-col">
            <!-- Header -->
            <div class="p-4 border-b border-white/20">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-6 h-6"></i>
                        AI Team
                    </h1>
                    <button onclick="toggleSidebar()" class="lg:hidden text-white/80 hover:text-white">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="flex gap-2">
                    <button onclick="createNewChat()" class="flex-1 bg-white text-purple-600 px-3 py-2 rounded-lg font-semibold hover:bg-white/90 transition-all text-sm flex items-center justify-center gap-1">
                        <i data-lucide="message-square" class="w-4 h-4"></i>
                        New Chat
                    </button>
                    <button onclick="createNewProject()" class="flex-1 bg-white/20 text-white px-3 py-2 rounded-lg font-semibold hover:bg-white/30 transition-all text-sm flex items-center justify-center gap-1">
                        <i data-lucide="folder-plus" class="w-4 h-4"></i>
                        Project
                    </button>
                </div>
            </div>
            
            <!-- Project Context (when project is active) -->
            <div id="projectContext" class="p-3 border-b border-white/20 bg-white/5" style="display: none;">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 flex-1 min-w-0">
                        <i data-lucide="folder" class="w-4 h-4 text-white/60 flex-shrink-0"></i>
                        <span id="currentProjectName" class="text-white text-sm font-semibold truncate">Project</span>
                    </div>
                    <button onclick="exitProject()" class="text-white/60 hover:text-white" title="Exit project">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <div id="sidebarTabs" class="flex border-b border-white/20 overflow-x-auto custom-scrollbar">
                <button onclick="switchTab('chats')" id="tab-chats" class="flex-1 px-3 py-3 text-white font-medium text-xs border-b-2 border-white transition-colors whitespace-nowrap">
                    Chats
                </button>
                <button onclick="switchTab('projects')" id="tab-projects" class="flex-1 px-3 py-3 text-white/60 font-medium text-xs border-b-2 border-transparent hover:text-white transition-colors whitespace-nowrap">
                    Projects
                </button>
            </div>
            
            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <div id="sidebar-chats" class="p-2"></div>
                <div id="sidebar-projects" class="p-2" style="display: none;"></div>
                <div id="sidebar-stories" class="p-2" style="display: none;"></div>
                <div id="sidebar-sprints" class="p-2" style="display: none;"></div>
                <div id="sidebar-agents" class="p-2" style="display: none;"></div>
            </div>
            
            <!-- Footer -->
            <div class="p-4 border-t border-white/20">
                <button onclick="navigateToSettings()" class="w-full text-white/80 hover:text-white px-4 py-2 rounded-lg hover:bg-white/10 transition-all flex items-center gap-2">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    Settings
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Chat View -->
            <div id="chatView" class="flex-1 flex flex-col" style="display: none;">
                <div class="glass border-b border-white/20 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-1">
                            <button onclick="toggleSidebar()" class="lg:hidden text-white/80 hover:text-white">
                                <i data-lucide="menu" class="w-6 h-6"></i>
                            </button>
                            <div class="flex-1">
                                <h2 id="chatTitle" class="text-xl font-semibold text-white">Chat</h2>
                                <div id="chatSubtitle" class="text-sm text-white/60"></div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="clearChat()" class="text-white/80 hover:text-white p-2" title="Clear">
                                <i data-lucide="eraser" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="messagesContainer" class="flex-1 overflow-y-auto custom-scrollbar p-4"></div>
                
                <div class="p-4 glass border-t border-white/20">
                    <div class="max-w-4xl mx-auto">
                        <div id="agentSelector" class="mb-3 flex gap-2 overflow-x-auto pb-2 custom-scrollbar"></div>
                        <div class="bg-white/10 rounded-2xl border border-white/20">
                            <textarea 
                                id="messageInput" 
                                placeholder="Type your message..." 
                                rows="1"
                                class="w-full px-4 py-3 bg-transparent text-white placeholder-white/40 resize-none focus:outline-none"
                                onkeydown="handleKeydown(event)"
                                oninput="autoResize(this)"
                            ></textarea>
                            <div class="flex justify-end px-4 pb-3">
                                <button onclick="sendMessage()" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold hover:bg-white/90 transition-all flex items-center gap-2">
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Welcome View -->
            <div id="welcomeView" class="flex-1 flex items-center justify-center p-8">
                <div class="text-center max-w-2xl">
                    <i data-lucide="sparkles" class="w-20 h-20 mx-auto mb-6 text-white/40"></i>
                    <h2 class="text-4xl font-bold text-white mb-4">Welcome to AI Team Manager</h2>
                    <p class="text-white/70 text-lg mb-8">Start a new chat or create a project to collaborate with your AI team</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="createNewChat()" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold hover:bg-white/90 transition-all flex items-center gap-2">
                            <i data-lucide="message-square" class="w-5 h-5"></i>
                            Start Chatting
                        </button>
                        <button onclick="createNewProject()" class="bg-white/20 text-white px-6 py-3 rounded-lg font-semibold hover:bg-white/30 transition-all flex items-center gap-2">
                            <i data-lucide="folder-plus" class="w-5 h-5"></i>
                            Create Project
                        </button>
                    </div>
                </div>
            </div>

            <!-- User Story Detail View -->
            <div id="storyDetailView" class="flex-1 overflow-y-auto custom-scrollbar p-8" style="display: none;">
                <div class="max-w-4xl mx-auto">
                    <button onclick="closeStoryDetail()" class="text-white/80 hover:text-white flex items-center gap-2 mb-4">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        Back
                    </button>
                    <div class="glass rounded-2xl p-6">
                        <input type="hidden" id="storyDetailId">
                        <div class="mb-6">
                            <label class="block text-white font-semibold mb-2">Title</label>
                            <input type="text" id="storyDetailTitle" class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white">
                        </div>
                        <div class="mb-6">
                            <label class="block text-white font-semibold mb-2">Description</label>
                            <textarea id="storyDetailDescription" class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white min-h-32"></textarea>
                        </div>
                        <div class="mb-6">
                            <label class="block text-white font-semibold mb-2">Status</label>
                            <select id="storyDetailStatus" class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white">
                                <option value="todo">To Do</option>
                                <option value="in-progress">In Progress</option>
                                <option value="done">Done</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <label class="block text-white font-semibold">Tasks</label>
                                <button onclick="addTaskToStory()" class="bg-white/20 text-white px-3 py-1 rounded text-sm">+ Add Task</button>
                            </div>
                            <div id="storyTasks" class="space-y-2"></div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="saveStoryDetail()" class="flex-1 bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold">Save</button>
                            <button onclick="deleteStory()" class="bg-red-500/20 text-red-100 px-6 py-3 rounded-lg font-semibold">Delete</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settingsView" class="flex-1 overflow-y-auto custom-scrollbar p-8" style="display: none;">
                <div class="max-w-2xl mx-auto">
                    <button onclick="closeSettings()" class="text-white/80 hover:text-white flex items-center gap-2 mb-4">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        Back
                    </button>
                    <h2 class="text-3xl font-bold text-white mb-6">Settings</h2>
                    
                    <div class="glass rounded-2xl p-6 mb-6">
                        <h3 class="text-white font-semibold mb-4 text-xl">OpenRouter API Key</h3>
                        <input type="password" id="apiKeyInput" placeholder="sk-or-v1-..." class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white mb-4">
                        <button onclick="saveSettings()" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold">Save</button>
                    </div>

                    <div class="glass rounded-2xl p-6">
                        <h3 class="text-white font-semibold mb-4 text-xl">Default AI Agents</h3>
                        <p class="text-white/70 text-sm mb-4">Configure default agents that will be available in all new projects</p>
                        <div id="defaultAgentsList" class="space-y-3"></div>
                        <button onclick="createCustomAgent()" class="mt-4 bg-white/20 text-white px-4 py-2 rounded-lg w-full">+ Create Custom Agent</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Edit Modal -->
    <div id="projectModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-white mb-4">Project Details</h2>
            <input type="hidden" id="projectModalId">
            <div class="mb-4">
                <label class="block text-white font-semibold mb-2">Name</label>
                <input type="text" id="projectModalName" class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white">
            </div>
            <div class="mb-4">
                <label class="block text-white font-semibold mb-2">Description</label>
                <textarea id="projectModalDescription" class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white min-h-24"></textarea>
            </div>
            <div class="flex gap-3">
                <button onclick="saveProject()" class="flex-1 bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold">Save</button>
                <button onclick="closeProjectModal()" class="bg-white/20 text-white px-6 py-3 rounded-lg font-semibold">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Agent Config Modal -->
    <div id="agentModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-white mb-4">Configure Agent</h2>
            <input type="hidden" id="agentModalId">
            <input type="hidden" id="agentModalProjectId">
            <div class="mb-4">
                <label class="block text-white font-semibold mb-2">Name</label>
                <input type="text" id="agentModalName" class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white">
            </div>
            <div class="mb-4">
                <label class="block text-white font-semibold mb-2">Role</label>
                <input type="text" id="agentModalRole" class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white">
            </div>
            <div class="mb-4">
                <label class="block text-white font-semibold mb-2">Icon (lucide name)</label>
                <input type="text" id="agentModalIcon" placeholder="code" class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white">
            </div>
            <div class="mb-4">
                <label class="block text-white font-semibold mb-2">Instructions</label>
                <textarea id="agentModalInstructions" class="w-full px-4 py-3 bg-white/10 border border-white/30 rounded-lg text-white min-h-32"></textarea>
            </div>
            <div class="mb-4">
                <label class="flex items-center gap-2 text-white cursor-pointer">
                    <input type="checkbox" id="agentModalEnabled" class="w-5 h-5">
                    <span>Enabled</span>
                </label>
            </div>
            <div class="flex gap-3">
                <button onclick="saveAgent()" class="flex-1 bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold">Save</button>
                <button onclick="closeAgentModal()" class="bg-white/20 text-white px-6 py-3 rounded-lg font-semibold">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * ============================================
         * DATA STRUCTURES & DEFAULTS
         * ============================================
         */

        // Default AI Agents Configuration
        const DEFAULT_AGENTS = [
            {
                id: 'product-owner',
                name: 'Product Owner',
                role: 'product-owner',
                icon: 'clipboard-list',
                instructions: 'You are an AI Product Owner. Gather requirements, define user stories, prioritize features, and ensure the product vision is clear. Work closely with stakeholders to understand business needs.',
                enabled: true,
                isDefault: true
            },
            {
                id: 'scrum-master',
                name: 'Scrum Master',
                role: 'scrum-master',
                icon: 'shield-check',
                instructions: 'You are an AI Scrum Master. Facilitate agile ceremonies, remove blockers, ensure best practices, and maintain team productivity. Keep the process running smoothly.',
                enabled: true,
                isDefault: true
            },
            {
                id: 'developer',
                name: 'Developer',
                role: 'developer',
                icon: 'code',
                instructions: 'You are an AI Developer. Write clean, efficient, well-documented code. Implement features, fix bugs, write tests, and follow coding best practices. Be proficient in multiple languages.',
                enabled: true,
                isDefault: true
            },
            {
                id: 'devops',
                name: 'DevOps Engineer',
                role: 'devops',
                icon: 'server',
                instructions: 'You are an AI DevOps Engineer. Manage deployment pipelines, infrastructure, CI/CD, monitoring, and system reliability. Work with containers, cloud, and automation.',
                enabled: true,
                isDefault: true
            },
            {
                id: 'tester',
                name: 'QA Tester',
                role: 'tester',
                icon: 'bug',
                instructions: 'You are an AI QA Tester. Design test cases, perform comprehensive testing (functional, integration, regression), identify bugs, and ensure quality standards.',
                enabled: true,
                isDefault: true
            },
            {
                id: 'qa',
                name: 'QA Engineer',
                role: 'qa',
                icon: 'check-circle',
                instructions: 'You are an AI QA Engineer. Perform code reviews, ensure quality standards, verify best practices, and maintain overall software quality. Prevent defects.',
                enabled: true,
                isDefault: true
            },
            {
                id: 'architect',
                name: 'System Architect',
                role: 'architect',
                icon: 'layout',
                instructions: 'You are an AI System Architect. Design system architecture, make technical decisions, define patterns and standards, ensure scalability and maintainability.',
                enabled: true,
                isDefault: true
            }
        ];

        /**
         * ============================================
         * ENCRYPTION & STORAGE
         * ============================================
         */
        class EncryptionManager {
            constructor() {
                this.keyMaterial = null;
            }

            async getKey() {
                if (this.keyMaterial) return this.keyMaterial;
                const fingerprint = navigator.userAgent + navigator.language;
                const encoder = new TextEncoder();
                const data = encoder.encode(fingerprint);
                const hash = await crypto.subtle.digest('SHA-256', data);
                this.keyMaterial = await crypto.subtle.importKey('raw', hash, { name: 'AES-GCM' }, false, ['encrypt', 'decrypt']);
                return this.keyMaterial;
            }

            async encrypt(text) {
                const key = await this.getKey();
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const encoded = new TextEncoder().encode(text);
                const encrypted = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, encoded);
                const combined = new Uint8Array(iv.length + encrypted.byteLength);
                combined.set(iv);
                combined.set(new Uint8Array(encrypted), iv.length);
                return btoa(String.fromCharCode(...combined));
            }

            async decrypt(encryptedData) {
                try {
                    const key = await this.getKey();
                    const combined = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
                    const iv = combined.slice(0, 12);
                    const data = combined.slice(12);
                    const decrypted = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, data);
                    return new TextDecoder().decode(decrypted);
                } catch (e) {
                    return null;
                }
            }
        }

        class StorageManager {
            constructor() {
                this.encryption = new EncryptionManager();
            }

            async saveApiKey(key) {
                if (key) {
                    const enc = await this.encryption.encrypt(key);
                    localStorage.setItem('enc_api_key', enc);
                } else {
                    localStorage.removeItem('enc_api_key');
                }
            }

            async loadApiKey() {
                const enc = localStorage.getItem('enc_api_key');
                return enc ? await this.encryption.decrypt(enc) : null;
            }

            save(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            }

            load(key, defaultValue = null) {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            }
        }

        /**
         * ============================================
         * APP MANAGER
         * ============================================
         */
        class AppManager {
            constructor() {
                this.storage = new StorageManager();
                this.chats = this.storage.load('chats', []);
                this.projects = this.storage.load('projects', []);
                this.userStories = this.storage.load('userStories', []);
                this.tasks = this.storage.load('tasks', []);
                this.sprints = this.storage.load('sprints', []);
                this.customAgents = this.storage.load('customAgents', []);
                
                this.currentChatId = null;
                this.currentProjectId = null;
                this.selectedAgent = null;
                this.currentView = 'welcome';
                this.sidebarTab = 'chats';
            }

            // === CHATS ===
            createChat(projectId = null) {
                const chat = {
                    id: Date.now().toString(),
                    projectId: projectId,
                    title: 'New Chat',
                    messages: [],
                    createdAt: new Date().toISOString()
                };
                this.chats.unshift(chat);
                this.storage.save('chats', this.chats);
                return chat;
            }

            updateChat(chatId, updates) {
                const idx = this.chats.findIndex(c => c.id === chatId);
                if (idx !== -1) {
                    this.chats[idx] = { ...this.chats[idx], ...updates };
                    this.storage.save('chats', this.chats);
                }
            }

            deleteChat(chatId) {
                this.chats = this.chats.filter(c => c.id !== chatId);
                this.storage.save('chats', this.chats);
            }

            getChat(chatId) {
                return this.chats.find(c => c.id === chatId);
            }

            // === PROJECTS ===
            createProject(data) {
                const project = {
                    id: Date.now().toString(),
                    name: data.name,
                    description: data.description || '',
                    agents: this.getDefaultAgents(),
                    createdAt: new Date().toISOString()
                };
                this.projects.unshift(project);
                this.storage.save('projects', this.projects);
                return project;
            }

            updateProject(projectId, updates) {
                const idx = this.projects.findIndex(p => p.id === projectId);
                if (idx !== -1) {
                    this.projects[idx] = { ...this.projects[idx], ...updates };
                    this.storage.save('projects', this.projects);
                }
            }

            deleteProject(projectId) {
                this.projects = this.projects.filter(p => p.id !== projectId);
                this.chats = this.chats.filter(c => c.projectId !== projectId);
                this.userStories = this.userStories.filter(s => s.projectId !== projectId);
                this.tasks = this.tasks.filter(t => t.projectId !== projectId);
                this.sprints = this.sprints.filter(s => s.projectId !== projectId);
                this.storage.save('projects', this.projects);
                this.storage.save('chats', this.chats);
                this.storage.save('userStories', this.userStories);
                this.storage.save('tasks', this.tasks);
                this.storage.save('sprints', this.sprints);
            }

            getProject(projectId) {
                return this.projects.find(p => p.id === projectId);
            }

            getDefaultAgents() {
                return [...DEFAULT_AGENTS, ...this.customAgents].map(a => ({ ...a }));
            }

            // === USER STORIES ===
            createUserStory(projectId, data) {
                const story = {
                    id: Date.now().toString(),
                    projectId: projectId,
                    title: data.title,
                    description: data.description || '',
                    status: data.status || 'todo',
                    sprintId: data.sprintId || null,
                    createdAt: new Date().toISOString()
                };
                this.userStories.unshift(story);
                this.storage.save('userStories', this.userStories);
                return story;
            }

            updateUserStory(storyId, updates) {
                const idx = this.userStories.findIndex(s => s.id === storyId);
                if (idx !== -1) {
                    this.userStories[idx] = { ...this.userStories[idx], ...updates };
                    this.storage.save('userStories', this.userStories);
                }
            }

            deleteUserStory(storyId) {
                this.userStories = this.userStories.filter(s => s.id !== storyId);
                this.tasks = this.tasks.filter(t => t.storyId !== storyId);
                this.storage.save('userStories', this.userStories);
                this.storage.save('tasks', this.tasks);
            }

            getUserStory(storyId) {
                return this.userStories.find(s => s.id === storyId);
            }

            getProjectStories(projectId) {
                return this.userStories.filter(s => s.projectId === projectId);
            }

            // === TASKS ===
            createTask(storyId, data) {
                const story = this.getUserStory(storyId);
                const task = {
                    id: Date.now().toString(),
                    storyId: storyId,
                    projectId: story.projectId,
                    title: data.title,
                    description: data.description || '',
                    status: data.status || 'todo',
                    priority: data.priority || 'medium',
                    assignedAgent: data.assignedAgent || null,
                    createdAt: new Date().toISOString()
                };
                this.tasks.unshift(task);
                this.storage.save('tasks', this.tasks);
                return task;
            }

            updateTask(taskId, updates) {
                const idx = this.tasks.findIndex(t => t.id === taskId);
                if (idx !== -1) {
                    this.tasks[idx] = { ...this.tasks[idx], ...updates };
                    this.storage.save('tasks', this.tasks);
                }
            }

            deleteTask(taskId) {
                this.tasks = this.tasks.filter(t => t.id !== taskId);
                this.storage.save('tasks', this.tasks);
            }

            getStoryTasks(storyId) {
                return this.tasks.filter(t => t.storyId === storyId);
            }

            // === SPRINTS ===
            createSprint(projectId, data) {
                const sprint = {
                    id: Date.now().toString(),
                    projectId: projectId,
                    name: data.name,
                    goal: data.goal || '',
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                this.sprints.unshift(sprint);
                this.storage.save('sprints', this.sprints);
                return sprint;
            }

            getProjectSprints(projectId) {
                return this.sprints.filter(s => s.projectId === projectId);
            }

            // === AGENTS ===
            createCustomAgent(data) {
                const agent = {
                    id: 'custom-' + Date.now(),
                    name: data.name,
                    role: data.role,
                    icon: data.icon || 'user',
                    instructions: data.instructions,
                    enabled: true,
                    isDefault: false
                };
                this.customAgents.push(agent);
                this.storage.save('customAgents', this.customAgents);
                return agent;
            }

            updateCustomAgent(agentId, updates) {
                const idx = this.customAgents.findIndex(a => a.id === agentId);
                if (idx !== -1) {
                    this.customAgents[idx] = { ...this.customAgents[idx], ...updates };
                    this.storage.save('customAgents', this.customAgents);
                }
            }

            deleteCustomAgent(agentId) {
                this.customAgents = this.customAgents.filter(a => a.id !== agentId);
                this.storage.save('customAgents', this.customAgents);
            }

            getAllAgents() {
                return [...DEFAULT_AGENTS, ...this.customAgents];
            }

            // === AI COMMUNICATION ===
            async sendToAI(message) {
                const apiKey = await this.storage.loadApiKey();
                if (!apiKey) throw new Error('API key not configured');

                const chat = this.getChat(this.currentChatId);
                const project = this.currentProjectId ? this.getProject(this.currentProjectId) : null;

                let messages = [];

                // Add agent instructions
                if (this.selectedAgent && project) {
                    const agent = project.agents.find(a => a.id === this.selectedAgent);
                    if (agent) {
                        messages.push({ role: 'system', content: agent.instructions });
                    }
                }

                // Add history
                messages = messages.concat(chat.messages.map(m => ({
                    role: m.role,
                    content: m.content
                })));

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'deepseek/deepseek-r1',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 4096
                    })
                });

                if (!response.ok) throw new Error('AI request failed');
                const data = await response.json();
                return data.choices[0].message.content;
            }
        }

        /**
         * ============================================
         * UI MANAGER
         * ============================================
         */
        class UIManager {
            constructor(app) {
                this.app = app;
            }

            showView(view) {
                ['welcomeView', 'chatView', 'storyDetailView', 'settingsView'].forEach(v => {
                    document.getElementById(v).style.display = 'none';
                });
                document.getElementById(view).style.display = view === 'chatView' ? 'flex' : 'block';
                this.app.currentView = view.replace('View', '');
            }

            renderSidebar() {
                const isProjectContext = !!this.app.currentProjectId;
                const projectContext = document.getElementById('projectContext');
                const tabs = document.getElementById('sidebarTabs');

                if (isProjectContext) {
                    const project = this.app.getProject(this.app.currentProjectId);
                    projectContext.style.display = 'block';
                    document.getElementById('currentProjectName').textContent = project.name;
                    
                    tabs.innerHTML = `
                        <button onclick="switchTab('chats')" id="tab-chats" class="flex-1 px-3 py-3 text-white/60 font-medium text-xs border-b-2 border-transparent hover:text-white transition-colors whitespace-nowrap">Chats</button>
                        <button onclick="switchTab('stories')" id="tab-stories" class="flex-1 px-3 py-3 text-white/60 font-medium text-xs border-b-2 border-transparent hover:text-white transition-colors whitespace-nowrap">Stories</button>
                        <button onclick="switchTab('sprints')" id="tab-sprints" class="flex-1 px-3 py-3 text-white/60 font-medium text-xs border-b-2 border-transparent hover:text-white transition-colors whitespace-nowrap">Sprints</button>
                        <button onclick="switchTab('agents')" id="tab-agents" class="flex-1 px-3 py-3 text-white/60 font-medium text-xs border-b-2 border-transparent hover:text-white transition-colors whitespace-nowrap">Agents</button>
                    `;
                } else {
                    projectContext.style.display = 'none';
                    tabs.innerHTML = `
                        <button onclick="switchTab('chats')" id="tab-chats" class="flex-1 px-3 py-3 text-white font-medium text-xs border-b-2 border-white transition-colors whitespace-nowrap">Chats</button>
                        <button onclick="switchTab('projects')" id="tab-projects" class="flex-1 px-3 py-3 text-white/60 font-medium text-xs border-b-2 border-transparent hover:text-white transition-colors whitespace-nowrap">Projects</button>
                    `;
                }

                this.switchTab(this.app.sidebarTab);
            }

            switchTab(tab) {
                this.app.sidebarTab = tab;
                ['chats', 'projects', 'stories', 'sprints', 'agents'].forEach(t => {
                    const btn = document.getElementById(`tab-${t}`);
                    const content = document.getElementById(`sidebar-${t}`);
                    if (btn) {
                        if (t === tab) {
                            btn.className = 'flex-1 px-3 py-3 text-white font-medium text-xs border-b-2 border-white transition-colors whitespace-nowrap';
                            content.style.display = 'block';
                        } else {
                            btn.className = 'flex-1 px-3 py-3 text-white/60 font-medium text-xs border-b-2 border-transparent hover:text-white transition-colors whitespace-nowrap';
                            content.style.display = 'none';
                        }
                    }
                });

                if (tab === 'chats') this.renderChats();
                if (tab === 'projects') this.renderProjects();
                if (tab === 'stories') this.renderStories();
                if (tab === 'sprints') this.renderSprints();
                if (tab === 'agents') this.renderAgents();
            }

            renderChats() {
                const container = document.getElementById('sidebar-chats');
                const chats = this.app.currentProjectId 
                    ? this.app.chats.filter(c => c.projectId === this.app.currentProjectId)
                    : this.app.chats.filter(c => !c.projectId);

                if (chats.length === 0) {
                    container.innerHTML = '<div class="text-white/40 text-center p-4 text-sm">No chats yet</div>';
                    return;
                }

                container.innerHTML = '';
                chats.forEach(chat => {
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-lg cursor-pointer transition-all ${chat.id === this.app.currentChatId ? 'bg-white/20' : 'hover:bg-white/10'}`;
                    div.onclick = () => this.openChat(chat.id);
                    div.innerHTML = `
                        <div class="flex items-start gap-2">
                            <i data-lucide="message-square" class="w-4 h-4 text-white/60 flex-shrink-0 mt-0.5"></i>
                            <div class="flex-1 min-w-0">
                                <p class="text-white text-sm font-medium truncate">${chat.title}</p>
                                <p class="text-white/40 text-xs">${new Date(chat.createdAt).toLocaleDateString()}</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
                lucide.createIcons();
            }

            renderProjects() {
                const container = document.getElementById('sidebar-projects');
                if (this.app.projects.length === 0) {
                    container.innerHTML = '<div class="text-white/40 text-center p-4 text-sm">No projects yet</div>';
                    return;
                }

                container.innerHTML = '';
                this.app.projects.forEach(project => {
                    const div = document.createElement('div');
                    div.className = 'card mb-3';
                    div.onclick = () => this.openProject(project.id);
                    div.innerHTML = `
                        <div class="flex items-start justify-between mb-2">
                            <h3 class="text-white font-semibold text-sm">${project.name}</h3>
                            <i data-lucide="folder" class="w-4 h-4 text-white/60"></i>
                        </div>
                        <p class="text-white/60 text-xs line-clamp-2">${project.description || 'No description'}</p>
                    `;
                    container.appendChild(div);
                });
                lucide.createIcons();
            }

            renderStories() {
                const container = document.getElementById('sidebar-stories');
                const stories = this.app.getProjectStories(this.app.currentProjectId);
                
                container.innerHTML = '<button onclick="createUserStoryPrompt()" class="w-full bg-white/20 text-white px-3 py-2 rounded-lg text-sm mb-3">+ New Story</button>';
                
                if (stories.length === 0) {
                    container.innerHTML += '<div class="text-white/40 text-center p-4 text-sm">No stories yet</div>';
                    return;
                }

                stories.forEach(story => {
                    const tasks = this.app.getStoryTasks(story.id);
                    const done = tasks.filter(t => t.status === 'done').length;
                    const div = document.createElement('div');
                    div.className = 'card mb-2';
                    div.onclick = () => this.openStoryDetail(story.id);
                    div.innerHTML = `
                        <div class="mb-2">
                            <span class="status-badge status-${story.status}">${story.status}</span>
                        </div>
                        <p class="text-white text-sm font-semibold mb-1">${story.title}</p>
                        <p class="text-white/60 text-xs">${done}/${tasks.length} tasks</p>
                    `;
                    container.appendChild(div);
                });
                lucide.createIcons();
            }

            renderSprints() {
                const container = document.getElementById('sidebar-sprints');
                const sprints = this.app.getProjectSprints(this.app.currentProjectId);
                
                container.innerHTML = '<button onclick="createSprintPrompt()" class="w-full bg-white/20 text-white px-3 py-2 rounded-lg text-sm mb-3">+ New Sprint</button>';
                
                if (sprints.length === 0) {
                    container.innerHTML += '<div class="text-white/40 text-center p-4 text-sm">No sprints yet</div>';
                    return;
                }

                sprints.forEach(sprint => {
                    const div = document.createElement('div');
                    div.className = 'card mb-2';
                    div.innerHTML = `
                        <h4 class="text-white font-semibold text-sm mb-1">${sprint.name}</h4>
                        <p class="text-white/60 text-xs">${sprint.goal || 'No goal'}</p>
                    `;
                    container.appendChild(div);
                });
                lucide.createIcons();
            }

            renderAgents() {
                const container = document.getElementById('sidebar-agents');
                const project = this.app.getProject(this.app.currentProjectId);
                
                container.innerHTML = '';
                project.agents.forEach(agent => {
                    const div = document.createElement('div');
                    div.className = 'card mb-2';
                    div.onclick = () => this.editProjectAgent(agent.id);
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i data-lucide="${agent.icon}" class="w-5 h-5 text-white"></i>
                                <div>
                                    <div class="text-white text-sm font-semibold">${agent.name}</div>
                                    <div class="text-white/60 text-xs">${agent.role}</div>
                                </div>
                            </div>
                            <span class="text-xs ${agent.enabled ? 'text-green-400' : 'text-white/40'}">${agent.enabled ? '' : ''}</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
                lucide.createIcons();
            }

            openChat(chatId) {
                this.app.currentChatId = chatId;
                const chat = this.app.getChat(chatId);
                
                document.getElementById('chatTitle').textContent = chat.title;
                document.getElementById('chatSubtitle').textContent = chat.projectId ? this.app.getProject(chat.projectId).name : 'Standalone Chat';
                
                this.showView('chatView');
                this.renderMessages(chat.messages);
                this.renderAgentSelector();
                this.renderSidebar();
                
                if (window.innerWidth < 1024) toggleSidebar();
            }

            openProject(projectId) {
                this.app.currentProjectId = projectId;
                this.renderSidebar();
                
                const chats = this.app.chats.filter(c => c.projectId === projectId);
                if (chats.length > 0) {
                    this.openChat(chats[0].id);
                } else {
                    const newChat = this.app.createChat(projectId);
                    this.openChat(newChat.id);
                }
            }

            openStoryDetail(storyId) {
                const story = this.app.getUserStory(storyId);
                document.getElementById('storyDetailId').value = story.id;
                document.getElementById('storyDetailTitle').value = story.title;
                document.getElementById('storyDetailDescription').value = story.description;
                document.getElementById('storyDetailStatus').value = story.status;
                
                this.renderStoryTasks(storyId);
                this.showView('storyDetailView');
            }

            renderStoryTasks(storyId) {
                const container = document.getElementById('storyTasks');
                const tasks = this.app.getStoryTasks(storyId);
                
                container.innerHTML = '';
                tasks.forEach(task => {
                    const div = document.createElement('div');
                    div.className = 'bg-white/10 rounded-lg p-3';
                    div.innerHTML = `
                        <div class="flex items-start justify-between mb-1">
                            <span class="status-badge status-${task.status}">${task.status}</span>
                            <button onclick="deleteTask('${task.id}')" class="text-red-400 text-xs">Delete</button>
                        </div>
                        <p class="text-white text-sm">${task.title}</p>
                    `;
                    container.appendChild(div);
                });
            }

            editProjectAgent(agentId) {
                const project = this.app.getProject(this.app.currentProjectId);
                const agent = project.agents.find(a => a.id === agentId);
                
                document.getElementById('agentModalId').value = agent.id;
                document.getElementById('agentModalProjectId').value = project.id;
                document.getElementById('agentModalName').value = agent.name;
                document.getElementById('agentModalRole').value = agent.role;
                document.getElementById('agentModalIcon').value = agent.icon;
                document.getElementById('agentModalInstructions').value = agent.instructions;
                document.getElementById('agentModalEnabled').checked = agent.enabled;
                
                document.getElementById('agentModal').style.display = 'flex';
                lucide.createIcons();
            }

            renderMessages(messages) {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center text-white/60">
                                <i data-lucide="message-circle" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                                <p>Start the conversation</p>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'fade-in mb-4';
                    
                    const isUser = msg.role === 'user';
                    const agentClass = msg.agentId ? `agent-${msg.agentId}` : (isUser ? 'message-user' : 'message-assistant');
                    
                    let agentBadge = '';
                    if (msg.agentId) {
                        const agent = this.app.getAllAgents().find(a => a.id === msg.agentId);
                        if (agent) {
                            agentBadge = `<div class="agent-badge"><i data-lucide="${agent.icon}" class="w-3 h-3"></i>${agent.name}</div>`;
                        }
                    }
                    
                    const html = marked.parse(msg.content);
                    
                    div.innerHTML = `
                        <div class="flex gap-3 ${isUser ? 'flex-row-reverse' : ''}">
                            <div class="w-10 h-10 rounded-full ${isUser ? 'bg-white/20' : 'bg-purple-500/30'} flex items-center justify-center flex-shrink-0">
                                <i data-lucide="${isUser ? 'user' : 'bot'}" class="w-5 h-5 text-white"></i>
                            </div>
                            <div class="${agentClass} rounded-2xl px-4 py-3 max-w-2xl">
                                ${agentBadge}
                                <div class="text-white prose prose-invert max-w-none">${html}</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
                
                container.scrollTop = container.scrollHeight;
                lucide.createIcons();
            }

            renderAgentSelector() {
                const container = document.getElementById('agentSelector');
                const project = this.app.currentProjectId ? this.app.getProject(this.app.currentProjectId) : null;
                
                container.innerHTML = '';
                
                if (!project) return;
                
                const enabled = project.agents.filter(a => a.enabled);
                enabled.forEach(agent => {
                    const btn = document.createElement('button');
                    btn.className = `px-3 py-2 rounded-full text-sm font-semibold transition-all ${
                        this.app.selectedAgent === agent.id ? 'bg-white text-purple-600' : 'bg-white/10 text-white hover:bg-white/20'
                    }`;
                    btn.onclick = () => {
                        this.app.selectedAgent = agent.id;
                        this.renderAgentSelector();
                    };
                    btn.innerHTML = `<i data-lucide="${agent.icon}" class="w-3 h-3 inline mr-1"></i>${agent.name}`;
                    container.appendChild(btn);
                });
                
                if (!this.app.selectedAgent && enabled.length > 0) {
                    this.app.selectedAgent = enabled[0].id;
                    this.renderAgentSelector();
                }
                
                lucide.createIcons();
            }

            renderDefaultAgents() {
                const container = document.getElementById('defaultAgentsList');
                container.innerHTML = '';
                
                this.app.getAllAgents().forEach(agent => {
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.onclick = () => this.editDefaultAgent(agent.id);
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i data-lucide="${agent.icon}" class="w-5 h-5 text-white"></i>
                                <span class="text-white font-semibold">${agent.name}</span>
                            </div>
                            ${agent.isDefault ? '<span class="text-xs text-white/60">Default</span>' : '<span class="text-xs text-blue-400">Custom</span>'}
                        </div>
                    `;
                    container.appendChild(div);
                });
                
                lucide.createIcons();
            }

            editDefaultAgent(agentId) {
                const agent = this.app.getAllAgents().find(a => a.id === agentId);
                
                document.getElementById('agentModalId').value = agent.id;
                document.getElementById('agentModalProjectId').value = '';
                document.getElementById('agentModalName').value = agent.name;
                document.getElementById('agentModalRole').value = agent.role;
                document.getElementById('agentModalIcon').value = agent.icon;
                document.getElementById('agentModalInstructions').value = agent.instructions;
                document.getElementById('agentModalEnabled').checked = agent.enabled;
                
                document.getElementById('agentModal').style.display = 'flex';
                lucide.createIcons();
            }

            notify(msg, type = 'info') {
                const div = document.createElement('div');
                div.className = 'fixed top-4 right-4 z-50 glass rounded-lg p-4 flex items-center gap-3 fade-in shadow-xl';
                const icons = { info: 'info', success: 'check-circle', error: 'alert-circle' };
                div.innerHTML = `
                    <i data-lucide="${icons[type]}" class="w-5 h-5 text-white"></i>
                    <p class="text-white">${msg}</p>
                `;
                document.body.appendChild(div);
                lucide.createIcons();
                setTimeout(() => div.remove(), 3000);
            }
        }

        /**
         * ============================================
         * GLOBAL INSTANCES & HANDLERS
         * ============================================
         */
        const app = new AppManager();
        const ui = new UIManager(app);

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('hidden');
        }

        function switchTab(tab) {
            ui.switchTab(tab);
        }

        function createNewChat() {
            const chat = app.createChat(app.currentProjectId);
            ui.openChat(chat.id);
        }

        function createNewProject() {
            document.getElementById('projectModalId').value = '';
            document.getElementById('projectModalName').value = '';
            document.getElementById('projectModalDescription').value = '';
            document.getElementById('projectModal').style.display = 'flex';
        }

        function saveProject() {
            const id = document.getElementById('projectModalId').value;
            const name = document.getElementById('projectModalName').value.trim();
            const description = document.getElementById('projectModalDescription').value.trim();
            
            if (!name) return ui.notify('Name required', 'error');
            
            if (id) {
                app.updateProject(id, { name, description });
                ui.notify('Project updated', 'success');
            } else {
                const project = app.createProject({ name, description });
                ui.notify('Project created', 'success');
                ui.openProject(project.id);
            }
            
            closeProjectModal();
        }

        function closeProjectModal() {
            document.getElementById('projectModal').style.display = 'none';
        }

        function exitProject() {
            app.currentProjectId = null;
            app.currentChatId = null;
            ui.renderSidebar();
            ui.showView('welcomeView');
        }

        function createUserStoryPrompt() {
            const title = prompt('Story title:');
            if (!title) return;
            app.createUserStory(app.currentProjectId, { title });
            ui.renderStories();
            ui.notify('Story created', 'success');
        }

        function createSprintPrompt() {
            const name = prompt('Sprint name:');
            if (!name) return;
            app.createSprint(app.currentProjectId, { name });
            ui.renderSprints();
            ui.notify('Sprint created', 'success');
        }

        function addTaskToStory() {
            const storyId = document.getElementById('storyDetailId').value;
            const title = prompt('Task title:');
            if (!title) return;
            app.createTask(storyId, { title });
            ui.renderStoryTasks(storyId);
            ui.notify('Task added', 'success');
        }

        function deleteTask(taskId) {
            if (!confirm('Delete task?')) return;
            app.deleteTask(taskId);
            const storyId = document.getElementById('storyDetailId').value;
            ui.renderStoryTasks(storyId);
            ui.notify('Task deleted', 'success');
        }

        function saveStoryDetail() {
            const id = document.getElementById('storyDetailId').value;
            const title = document.getElementById('storyDetailTitle').value.trim();
            const description = document.getElementById('storyDetailDescription').value.trim();
            const status = document.getElementById('storyDetailStatus').value;
            
            if (!title) return ui.notify('Title required', 'error');
            
            app.updateUserStory(id, { title, description, status });
            ui.notify('Story saved', 'success');
            closeStoryDetail();
        }

        function deleteStory() {
            const id = document.getElementById('storyDetailId').value;
            if (!confirm('Delete story and all tasks?')) return;
            app.deleteUserStory(id);
            ui.notify('Story deleted', 'success');
            closeStoryDetail();
        }

        function closeStoryDetail() {
            ui.showView('chatView');
            ui.renderStories();
        }

        function saveAgent() {
            const id = document.getElementById('agentModalId').value;
            const projectId = document.getElementById('agentModalProjectId').value;
            const name = document.getElementById('agentModalName').value.trim();
            const role = document.getElementById('agentModalRole').value.trim();
            const icon = document.getElementById('agentModalIcon').value.trim();
            const instructions = document.getElementById('agentModalInstructions').value.trim();
            const enabled = document.getElementById('agentModalEnabled').checked;
            
            if (!name || !instructions) return ui.notify('Name and instructions required', 'error');
            
            if (projectId) {
                // Update project agent
                const project = app.getProject(projectId);
                const idx = project.agents.findIndex(a => a.id === id);
                if (idx !== -1) {
                    project.agents[idx] = { ...project.agents[idx], name, role, icon, instructions, enabled };
                    app.updateProject(projectId, { agents: project.agents });
                }
                ui.renderAgents();
            } else {
                // Update custom agent
                if (id.startsWith('custom-')) {
                    app.updateCustomAgent(id, { name, role, icon, instructions, enabled });
                } else {
                    // Create new custom agent
                    app.createCustomAgent({ name, role, icon, instructions });
                }
                ui.renderDefaultAgents();
            }
            
            closeAgentModal();
            ui.notify('Agent saved', 'success');
        }

        function closeAgentModal() {
            document.getElementById('agentModal').style.display = 'none';
        }

        function createCustomAgent() {
            document.getElementById('agentModalId').value = '';
            document.getElementById('agentModalProjectId').value = '';
            document.getElementById('agentModalName').value = '';
            document.getElementById('agentModalRole').value = '';
            document.getElementById('agentModalIcon').value = 'user';
            document.getElementById('agentModalInstructions').value = '';
            document.getElementById('agentModalEnabled').checked = true;
            document.getElementById('agentModal').style.display = 'flex';
        }

        function navigateToSettings() {
            ui.showView('settingsView');
            ui.renderDefaultAgents();
        }

        function closeSettings() {
            if (app.currentChatId) {
                ui.showView('chatView');
            } else {
                ui.showView('welcomeView');
            }
        }

        async function saveSettings() {
            const key = document.getElementById('apiKeyInput').value;
            await app.storage.saveApiKey(key);
            document.getElementById('apiKeyInput').value = '';
            ui.notify('Settings saved', 'success');
        }

        function handleKeydown(e) {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        function clearChat() {
            if (!confirm('Clear all messages?')) return;
            app.updateChat(app.currentChatId, { messages: [] });
            ui.renderMessages([]);
            ui.notify('Chat cleared', 'info');
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            const chat = app.getChat(app.currentChatId);
            
            chat.messages.push({
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            });
            
            app.updateChat(chat.id, { messages: chat.messages });
            
            input.value = '';
            input.style.height = 'auto';
            
            ui.renderMessages(chat.messages);
            
            // Add typing indicator
            const container = document.getElementById('messagesContainer');
            const typing = document.createElement('div');
            typing.id = 'typing';
            typing.className = 'flex gap-3 fade-in mb-4';
            typing.innerHTML = `
                <div class="w-10 h-10 rounded-full bg-purple-500/30 flex items-center justify-center">
                    <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                </div>
                <div class="message-assistant rounded-2xl px-4 py-3">
                    <div class="flex gap-1">
                        <div class="w-2 h-2 bg-white/60 rounded-full animate-pulse"></div>
                        <div class="w-2 h-2 bg-white/60 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-white/60 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                    </div>
                </div>
            `;
            container.appendChild(typing);
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
            
            try {
                const response = await app.sendToAI(message);
                
                document.getElementById('typing').remove();
                
                chat.messages.push({
                    role: 'assistant',
                    content: response,
                    agentId: app.selectedAgent,
                    timestamp: new Date().toISOString()
                });
                
                app.updateChat(chat.id, { messages: chat.messages });
                ui.renderMessages(chat.messages);
                ui.renderSidebar();
                
            } catch (error) {
                document.getElementById('typing')?.remove();
                ui.notify(error.message, 'error');
            }
        }

        // Initialize
        marked.setOptions({ breaks: true, gfm: true });
        lucide.createIcons();
        
        if (app.chats.length === 0 && app.projects.length === 0) {
            ui.showView('welcomeView');
        } else {
            ui.showView('welcomeView');
        }
        
        ui.renderSidebar();

        console.log(' AI Team Manager initialized!');
    </script>
</body>
</html>
