<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Pro Client - Multi-User</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        'primary-dark': '#4f46e5',
                        secondary: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .spinner { animation: spin 1s linear infinite; }
        .toast { animation: slideIn 0.3s ease; }
        .progress-shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }
        #editor {
            height: 100%;
            min-height: 500px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500">
    <div class="flex h-screen overflow-hidden">
        <div class="w-72 bg-gray-900 text-white flex flex-col shadow-2xl">
            <div class="p-6 bg-gray-800 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <i class="fab fa-github text-3xl text-indigo-400"></i>
                    <span class="text-xl font-bold">GitHub Pro</span>
                </div>
                <div class="mt-3" id="permissionBadge"></div>
                <div class="mt-2" id="authStatus"></div>
            </div>
            
            <nav class="flex-1 overflow-y-auto py-4">
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500 active" onclick="switchView('clone')">
                    <i class="fas fa-download w-5"></i>
                    <span>Clone Repository</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('files')">
                    <i class="fas fa-folder w-5"></i>
                    <span>File Explorer</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('search')">
                    <i class="fas fa-search w-5"></i>
                    <span>Search Code</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('commits')">
                    <i class="fas fa-code-commit w-5"></i>
                    <span>Commits</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('branches')">
                    <i class="fas fa-code-branch w-5"></i>
                    <span>Branches</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('info')">
                    <i class="fas fa-info-circle w-5"></i>
                    <span>Repository Info</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('permissions')">
                    <i class="fas fa-user-shield w-5"></i>
                    <span>Permissions</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('settings')">
                    <i class="fas fa-cog w-5"></i>
                    <span>Settings</span>
                </div>
            </nav>
        </div>

        <div class="flex-1 flex flex-col bg-gray-50 overflow-hidden">
            <div class="bg-white shadow-md px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-semibold text-gray-800" id="topbarTitle">GitHub Pro Client</h1>
                    <span class="hidden bg-indigo-600 text-white px-3 py-1 rounded-full text-sm font-medium" id="repoBadge"></span>
                    <span class="hidden text-sm text-gray-600" id="userInfo"></span>
                </div>
                <div class="flex gap-3">
                    <button class="hidden bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2" onclick="downloadAsZip()" id="downloadZipBtn">
                        <i class="fas fa-download"></i> Download ZIP
                    </button>
                    <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2" onclick="clearAllData()">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto overflow-x-hidden">
                <div class="view-container p-6" id="view-clone">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-download text-indigo-600"></i>
                            Clone Repository
                        </h2>
                        
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-1">Authentication Guide</h4>
                                    <ul class="text-sm text-blue-700 space-y-1">
                                        <li>• <strong>Public repos:</strong> No token needed - leave blank</li>
                                        <li>• <strong>Private repos:</strong> Token required</li>
                                        <li>• <strong>To push changes:</strong> Token required</li>
                                        <li>• You can add/update token anytime</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="mb-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-key"></i> GitHub Personal Access Token (Optional for public repos)
                            </label>
                            <div class="flex gap-2">
                                <input type="password" id="tokenInput" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx (leave empty for public repos)">
                                <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg font-medium transition-colors" onclick="updateToken()">
                                    <i class="fas fa-sync"></i> Update
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Token needed for: private repos, pushing changes, higher API rate limits
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fab fa-github"></i> Repository URL or Owner/Repo
                                </label>
                                <input type="text" id="repoInput" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors" placeholder="owner/repo">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-code-branch"></i> Branch
                                </label>
                                <input type="text" id="branchInput" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors" placeholder="main" value="main">
                            </div>
                        </div>

                        <div id="cloneProgress" class="hidden mb-5">
                            <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-600 transition-all duration-300 relative progress-shimmer" id="cloneProgressBar" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-2" id="cloneProgressText">Preparing...</p>
                        </div>

                        <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2" onclick="cloneRepository()">
                            <i class="fas fa-download"></i> Clone Repository
                        </button>
                    </div>

                    <div class="hidden grid grid-cols-4 gap-4 mb-6" id="statsGrid">
                        <div class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-xl shadow-lg p-6">
                            <div class="text-3xl font-bold mb-2" id="statFiles">0</div>
                            <div class="text-sm opacity-90"><i class="fas fa-file"></i> Files</div>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-teal-600 text-white rounded-xl shadow-lg p-6">
                            <div class="text-3xl font-bold mb-2" id="statSize">0 KB</div>
                            <div class="text-sm opacity-90"><i class="fas fa-database"></i> Total Size</div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-500 to-red-600 text-white rounded-xl shadow-lg p-6">
                            <div class="text-3xl font-bold mb-2" id="statCommits">0</div>
                            <div class="text-sm opacity-90"><i class="fas fa-code-commit"></i> Commits</div>
                        </div>
                        <div class="bg-gradient-to-br from-pink-500 to-rose-600 text-white rounded-xl shadow-lg p-6">
                            <div class="text-3xl font-bold mb-2" id="statBranches">0</div>
                            <div class="text-sm opacity-90"><i class="fas fa-code-branch"></i> Branches</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Console Output</h3>
                        <div class="bg-gray-900 text-green-400 p-5 rounded-lg font-mono text-sm h-96 overflow-y-auto" id="consoleOutput"></div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-files">
                    <div class="grid grid-cols-[300px_1fr] gap-6 h-[calc(100vh-140px)]">
                        <div class="bg-white rounded-xl shadow-lg p-4 overflow-y-auto">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">File Tree</h3>
                            <div id="fileTree" class="text-sm">
                                <div class="text-center text-gray-400 py-8">Clone a repository first</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg flex flex-col overflow-hidden">
                            <div class="bg-gray-800 text-white px-6 py-4 flex items-center justify-between">
                                <div class="flex items-center gap-3 font-medium" id="editorFilename">
                                    <i class="fas fa-file-code"></i>
                                    <span>No file selected</span>
                                </div>
                                <div class="flex gap-3">
                                    <button class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" onclick="saveFile()" id="saveBtn" disabled>
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                    <button class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" onclick="showCommitModal()" id="commitBtn" disabled>
                                        <i class="fas fa-upload"></i> Commit & Push
                                    </button>
                                </div>
                            </div>
                            <div id="editor" class="flex-1"></div>
                        </div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-search">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-search text-indigo-600"></i>
                            Search Code
                        </h2>
                        <div class="flex gap-4">
                            <div class="flex-1 relative">
                                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="searchInput" class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors" placeholder="Search for code, file names, content..." onkeypress="if(event.key==='Enter') searchCode()">
                            </div>
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2" onclick="searchCode()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    <div class="space-y-4" id="searchResults"></div>
                </div>

                <div class="view-container hidden p-6" id="view-commits">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-code-commit text-indigo-600"></i>
                                Commit History
                            </h2>
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2" onclick="loadCommits()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                        <div class="space-y-4" id="commitsList"></div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-branches">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-code-branch text-indigo-600"></i>
                                Branches
                            </h2>
                            <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2" onclick="loadBranches()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                        <div class="space-y-4" id="branchesList"></div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-info">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-info-circle text-indigo-600"></i>
                            Repository Information
                        </h2>
                        <div class="bg-gray-900 text-green-400 p-5 rounded-lg font-mono text-sm overflow-y-auto max-h-[600px]" id="infoOutput"></div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-permissions">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-user-shield text-indigo-600"></i>
                            Permission Management
                        </h2>

                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                            <h4 class="font-semibold text-blue-800 mb-2">How Authentication Works</h4>
                            <ul class="text-sm text-blue-700 space-y-1 list-disc list-inside">
                                <li><strong>Public repos:</strong> No authentication needed - full read access</li>
                                <li><strong>Private repos:</strong> Requires GitHub token with repo access</li>
                                <li><strong>Write operations:</strong> Always require authentication (even for public repos)</li>
                                <li>Each user authenticates with their own token for security</li>
                            </ul>
                        </div>

                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Current Status</h3>
                            <div id="currentPermissions" class="bg-gray-50 rounded-lg p-4">
                                <p class="text-gray-500 text-sm">Clone a repository to view your permissions</p>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Available Actions</h3>
                            <div class="space-y-4">
                                <div class="border-l-4 border-green-500 bg-green-50 p-4 rounded">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas fa-check-circle text-green-600"></i>
                                        <h4 class="font-semibold text-green-800">Without Token (Public Repos)</h4>
                                    </div>
                                    <p class="text-sm text-green-700">Clone, read files, search code, download ZIP, view commits/branches</p>
                                </div>

                                <div class="border-l-4 border-blue-500 bg-blue-50 p-4 rounded">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas fa-key text-blue-600"></i>
                                        <h4 class="font-semibold text-blue-800">With Token (Authenticated)</h4>
                                    </div>
                                    <p class="text-sm text-blue-700">Everything above PLUS: clone private repos, edit files, commit & push changes, view collaborators</p>
                                </div>

                                <div class="border-l-4 border-yellow-500 bg-yellow-50 p-4 rounded">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                                        <h4 class="font-semibold text-yellow-800">Disabled Features</h4>
                                    </div>
                                    <p class="text-sm text-yellow-700" id="disabledFeatures">Add a token to enable all features</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Setup Instructions</h3>
                            <div class="bg-gray-50 rounded-lg p-4 space-y-3 text-sm">
                                <div class="flex items-start gap-3">
                                    <span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 mt-0.5">1</span>
                                    <p class="text-gray-700"><strong>For public repos:</strong> Just enter the repo URL and click Clone (no token needed)</p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 mt-0.5">2</span>
                                    <p class="text-gray-700"><strong>For private repos or to push changes:</strong> Get a GitHub token (Settings → Developer settings → Personal access tokens)</p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 mt-0.5">3</span>
                                    <p class="text-gray-700">Enter your token and click "Update" - permissions will be re-checked automatically</p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <span class="bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0 mt-0.5">4</span>
                                    <p class="text-gray-700">You can add/update your token at any time, even after cloning</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6" id="collaboratorsSection">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Repository Collaborators</h3>
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-4">
                            <p class="text-sm text-yellow-700"><i class="fas fa-info-circle"></i> Authentication required to view collaborators</p>
                        </div>
                        <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" onclick="loadCollaborators()" id="loadCollabBtn" disabled>
                            <i class="fas fa-sync"></i> Load Collaborators
                        </button>
                        <div id="collaboratorsList" class="mt-4"></div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-settings">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-cog text-indigo-600"></i>
                            Settings
                        </h2>
                        <div class="mb-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Git User Name</label>
                            <input type="text" id="gitUserName" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors" placeholder="Your Name">
                        </div>
                        <div class="mb-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Git User Email</label>
                            <input type="email" id="gitUserEmail" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors" placeholder="your@email.com">
                        </div>
                        <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Storage Info</h3>
                        <div class="bg-gray-900 text-green-400 p-5 rounded-lg font-mono text-sm mb-4" id="storageInfo">Calculating...</div>
                        <button class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2" onclick="showStorageInfo()">
                            <i class="fas fa-sync"></i> Refresh Storage Info
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="hidden fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50" id="loadingOverlay">
        <div class="bg-white rounded-2xl p-10 text-center max-w-md">
            <div class="w-16 h-16 border-4 border-gray-200 border-t-indigo-600 rounded-full mx-auto mb-6 spinner"></div>
            <div class="text-xl font-semibold text-gray-800 mb-2" id="loadingText">Processing...</div>
            <div class="text-sm text-gray-600" id="loadingSubtext">Please wait</div>
        </div>
    </div>

    <div class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50" id="commitModal">
        <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4">
            <h3 class="text-2xl font-semibold text-gray-800 mb-6">Commit Changes</h3>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Commit Message</label>
                <textarea id="commitMessage" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors resize-none" rows="4" placeholder="Describe your changes..."></textarea>
            </div>
            <div class="flex justify-end gap-3">
                <button class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition-colors" onclick="closeCommitModal()">Cancel</button>
                <button class="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2" onclick="commitAndPush()">
                    <i class="fas fa-upload"></i> Commit & Push
                </button>
            </div>
        </div>
    </div>

    <div class="fixed top-6 right-6 z-50 flex flex-col gap-3" id="toastContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        var originalDefine = window.define;
        window.define = undefined; // Hide AMD from FileSaver
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        window.define = originalDefine; // Restore AMD
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"></script>

    <script>
        // Global state
        let db;
        let currentRepo = {
            owner: '',
            repo: '',
            branch: '',
            token: ''
        };
        let userPermissions = {
            permission: 'none', // none, read, write, admin
            canPush: false,
            canPull: true,
            isOwner: false,
            username: '',
            authenticated: false
        };
        let monacoEditor;
        let monacoInitPromise = null; // FIX: Add promise tracker for monaco init
        let currentFile = null;
        let fileModified = false;

        // Initialize IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('GitHubProDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('files')) {
                        db.createObjectStore('files', { keyPath: 'path' });
                    }
                    if (!db.objectStoreNames.contains('metadata')) {
                        db.createObjectStore('metadata', { keyPath: 'key' });
                    }
                };
            });
        }

        // IndexedDB operations
        async function saveToIndexedDB(storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getFromIndexedDB(storeName, key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function getAllFromIndexedDB(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function clearIndexedDB(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Check if token exists and is valid
        function hasToken() {
            return currentRepo.token && currentRepo.token.trim() !== '';
        }

        // Update token
        async function updateToken() {
            const newToken = document.getElementById('tokenInput').value.trim();
            currentRepo.token = newToken;
            
            if (currentRepo.owner && currentRepo.repo) {
                await saveToIndexedDB('metadata', {
                    key: 'currentRepo',
                    value: currentRepo
                });
                
                if (hasToken()) {
                    showLoading('Checking permissions...', 'Please wait');
                    await checkUserPermissions();
                    hideLoading();
                    showToast('Token updated and permissions refreshed', 'success');
                } else {
                    userPermissions.authenticated = false;
                    userPermissions.canPush = false;
                    userPermissions.permission = 'read';
                    userPermissions.username = 'Anonymous';
                    updatePermissionUI();
                    showToast('Token removed - using public access mode', 'info');
                }
            } else {
                showToast('Token saved - will be used for next clone', 'info');
            }
        }

        // GitHub API Helper - with optional auth
        function getHeaders() {
            const headers = {
                'Accept': 'application/vnd.github+json',
                'X-GitHub-Api-Version': '2022-11-28'
            };
            
            if (hasToken()) {
                headers['Authorization'] = `Bearer ${currentRepo.token}`;
            }
            
            return headers;
        }

        // Permission Management
        async function checkUserPermissions() {
            try {
                if (!hasToken()) {
                    // No token - public access mode
                    userPermissions.authenticated = false;
                    userPermissions.permission = 'read';
                    userPermissions.canPush = false;
                    userPermissions.canPull = true;
                    userPermissions.isOwner = false;
                    userPermissions.username = 'Anonymous (Public Access)';
                    updatePermissionUI();
                    log(`✓ Mode: Public access (no authentication)`);
                    return;
                }

                // Get authenticated user info
                const userResponse = await fetch('https://api.github.com/user', {
                    headers: getHeaders()
                });

                if (!userResponse.ok) {
                    throw new Error('Invalid token or authentication failed');
                }

                const user = await userResponse.json();
                userPermissions.username = user.login;
                userPermissions.authenticated = true;

                // Get repository permissions
                const permResponse = await fetch(
                    `https://api.github.com/repos/${currentRepo.owner}/${currentRepo.repo}`,
                    { headers: getHeaders() }
                );

                if (!permResponse.ok) {
                    userPermissions.permission = 'none';
                    userPermissions.canPush = false;
                    userPermissions.canPull = false;
                    updatePermissionUI();
                    return;
                }

                const repoData = await permResponse.json();
                
                // Check if user is owner
                userPermissions.isOwner = repoData.owner.login === user.login;

                // Determine permissions
                if (userPermissions.isOwner || repoData.permissions?.admin) {
                    userPermissions.permission = 'admin';
                    userPermissions.canPush = true;
                    userPermissions.canPull = true;
                } else if (repoData.permissions?.push) {
                    userPermissions.permission = 'write';
                    userPermissions.canPush = true;
                    userPermissions.canPull = true;
                } else if (repoData.permissions?.pull) {
                    userPermissions.permission = 'read';
                    userPermissions.canPush = false;
                    userPermissions.canPull = true;
                } else {
                    userPermissions.permission = 'none';
                    userPermissions.canPush = false;
                    userPermissions.canPull = false;
                }

                updatePermissionUI();
                
                log(`✓ User: ${userPermissions.username}`);
                log(`✓ Permission level: ${userPermissions.permission}`);

            } catch (error) {
                log(`⚠️  Permission check failed: ${error.message}`, 'text-yellow-400');
                // Fallback to public access
                userPermissions.authenticated = false;
                userPermissions.permission = 'read';
                userPermissions.canPush = false;
                userPermissions.canPull = true;
                userPermissions.username = 'Anonymous (Public Access)';
                updatePermissionUI();
            }
        }

        function updatePermissionUI() {
            const badge = document.getElementById('permissionBadge');
            const userInfo = document.getElementById('userInfo');
            const authStatus = document.getElementById('authStatus');
            const currentPerms = document.getElementById('currentPermissions');
            const loadCollabBtn = document.getElementById('loadCollabBtn');

            let badgeClass = '';
            let badgeIcon = '';
            let badgeText = '';
            let authStatusHtml = '';

            if (!userPermissions.authenticated) {
                badgeClass = 'bg-gray-500';
                badgeIcon = 'fa-globe';
                badgeText = 'Public Access';
                authStatusHtml = '<div class="text-xs text-gray-400 mt-1"><i class="fas fa-info-circle"></i> No authentication</div>';
            } else {
                switch(userPermissions.permission) {
                    case 'admin':
                        badgeClass = 'bg-green-500';
                        badgeIcon = 'fa-crown';
                        badgeText = 'Admin';
                        break;
                    case 'write':
                        badgeClass = 'bg-blue-500';
                        badgeIcon = 'fa-pen';
                        badgeText = 'Write Access';
                        break;
                    case 'read':
                        badgeClass = 'bg-yellow-500';
                        badgeIcon = 'fa-eye';
                        badgeText = 'Read Only';
                        break;
                    default:
                        badgeClass = 'bg-red-500';
                        badgeIcon = 'fa-ban';
                        badgeText = 'No Access';
                }
                authStatusHtml = '<div class="text-xs text-green-400 mt-1"><i class="fas fa-check-circle"></i> Authenticated</div>';
            }

            badge.innerHTML = `
                <div class="${badgeClass} text-white px-3 py-1 rounded-lg text-xs font-medium flex items-center gap-2">
                    <i class="fas ${badgeIcon}"></i>
                    <span>${badgeText}</span>
                </div>
            `;

            authStatus.innerHTML = authStatusHtml;

            userInfo.textContent = `User: ${userPermissions.username}`;
            userInfo.classList.remove('hidden');

            // Show detailed permissions
            if (currentPerms) {
                const disabledFeatures = [];
                if (!userPermissions.authenticated) {
                    disabledFeatures.push('Private repositories', 'Push/Commit changes', 'View collaborators');
                } else if (!userPermissions.canPush) {
                    disabledFeatures.push('Push/Commit changes');
                }

                currentPerms.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700">Username:</span>
                            <span class="font-medium">${userPermissions.username}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700">Authentication:</span>
                            <span class="font-medium ${userPermissions.authenticated ? 'text-green-600' : 'text-gray-600'}">${userPermissions.authenticated ? 'Authenticated' : 'Public Access'}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700">Permission Level:</span>
                            <span class="font-medium ${userPermissions.permission === 'admin' ? 'text-green-600' : userPermissions.permission === 'write' ? 'text-blue-600' : 'text-yellow-600'}">${userPermissions.permission.toUpperCase()}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700">Can Clone/Read:</span>
                            <span class="font-medium ${userPermissions.canPull ? 'text-green-600' : 'text-red-600'}">${userPermissions.canPull ? 'Yes' : 'No'}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-700">Can Edit/Push:</span>
                            <span class="font-medium ${userPermissions.canPush ? 'text-green-600' : 'text-red-600'}">${userPermissions.canPush ? 'Yes' : 'No'}</span>
                        </div>
                    </div>
                `;

                // Update disabled features text
                const disabledFeaturesEl = document.getElementById('disabledFeatures');
                if (disabledFeaturesEl) {
                    if (disabledFeatures.length > 0) {
                        disabledFeaturesEl.textContent = 'Disabled: ' + disabledFeatures.join(', ');
                    } else {
                        disabledFeaturesEl.textContent = 'All features enabled';
                    }
                }
            }

            // Update button states
            const saveBtn = document.getElementById('saveBtn');
            const commitBtn = document.getElementById('commitBtn');
            
            if (!userPermissions.canPush) {
                if (saveBtn) saveBtn.disabled = true;
                if (commitBtn) commitBtn.disabled = true;
                if (saveBtn) saveBtn.title = 'Authentication required for write access';
                if (commitBtn) commitBtn.title = 'Authentication required for write access';
            }

            // Update collaborators button
            if (loadCollabBtn) {
                loadCollabBtn.disabled = !userPermissions.authenticated;
            }

            // Update editor if it exists
            if (monacoEditor) {
                monacoEditor.updateOptions({ readOnly: !userPermissions.canPush });
            }
        }

        function checkPermission(action) {
            switch(action) {
                case 'read':
                    return userPermissions.canPull;
                case 'write':
                case 'push':
                    return userPermissions.canPush && userPermissions.authenticated;
                case 'admin':
                    return userPermissions.permission === 'admin' && userPermissions.authenticated;
                default:
                    return false;
            }
        }

        // UI Functions
        function switchView(viewName) {
            document.querySelectorAll('.view-container').forEach(v => v.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('bg-indigo-600', 'border-indigo-500');
            });
            
            document.getElementById('view-' + viewName).classList.remove('hidden');
            if (event && event.target) {
                event.target.closest('.nav-item').classList.add('bg-indigo-600', 'border-indigo-500');
            }
        }

        function showLoading(text = 'Processing...', subtext = 'Please wait') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSubtext').textContent = subtext;
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('loadingOverlay').classList.remove('flex');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-white border-l-4 border-emerald-500',
                error: 'bg-white border-l-4 border-red-500',
                info: 'bg-white border-l-4 border-blue-500',
                warning: 'bg-white border-l-4 border-yellow-500'
            };
            
            const icons = {
                success: 'fa-check-circle text-emerald-500',
                error: 'fa-exclamation-circle text-red-500',
                info: 'fa-info-circle text-blue-500',
                warning: 'fa-exclamation-triangle text-yellow-500'
            };
            
            toast.className = `toast ${colors[type]} rounded-lg shadow-xl p-4 flex items-center gap-3 min-w-[300px]`;
            toast.innerHTML = `
                <i class="fas ${icons[type]} text-xl"></i>
                <span class="text-gray-800">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function log(message, color = 'text-green-400') {
            const output = document.getElementById('consoleOutput');
            if (!output) return;
            const line = document.createElement('div');
            line.className = color;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function parseRepoUrl(url) {
            const match = url.match(/github\.com\/([^\/]+)\/([^\/\.]+)/);
            if (match) {
                return { owner: match[1], repo: match[2] };
            }
            
            const parts = url.split('/');
            if (parts.length === 2) {
                return { owner: parts[0], repo: parts[1] };
            }
            
            return null;
        }

        // Clone Repository
        async function cloneRepository() {
            const token = document.getElementById('tokenInput').value.trim();
            const repoInput = document.getElementById('repoInput').value.trim();
            const branch = document.getElementById('branchInput').value.trim() || 'main';

            if (!repoInput) {
                showToast('Please enter a repository URL', 'error');
                return;
            }

            const parsed = parseRepoUrl(repoInput);
            if (!parsed) {
                showToast('Invalid repository format', 'error');
                return;
            }

            currentRepo = {
                owner: parsed.owner,
                repo: parsed.repo,
                branch: branch,
                token: token
            };

            document.getElementById('consoleOutput').textContent = '';
            
            if (hasToken()) {
                showLoading('Checking permissions...', 'Please wait');
            } else {
                showLoading('Cloning public repository...', 'No authentication');
            }
            
            try {
                // Check user permissions
                await checkUserPermissions();

                if (!checkPermission('read')) {
                    throw new Error('You do not have permission to access this repository');
                }

                log(`🚀 Starting clone: ${currentRepo.owner}/${currentRepo.repo}`);
                log(`📍 Branch: ${branch}`);
                if (!hasToken()) {
                    log(`ℹ️  Mode: Public access (no authentication)`);
                }
                
                // Show progress
                document.getElementById('cloneProgress').classList.remove('hidden');
                updateProgress(10, 'Fetching repository info...');

                // Get repo info
                const infoResponse = await fetch(
                    `https://api.github.com/repos/${currentRepo.owner}/${currentRepo.repo}`,
                    { headers: getHeaders() }
                );

                if (!infoResponse.ok) {
                    if (infoResponse.status === 404) {
                        throw new Error('Repository not found or is private (authentication required)');
                    }
                    throw new Error(`Failed to access repository: ${infoResponse.status}`);
                }

                const repoInfo = await infoResponse.json();
                await saveToIndexedDB('metadata', { key: 'repoInfo', value: repoInfo });
                log(`✓ Repository info retrieved`);
                
                updateProgress(20, 'Fetching file tree...');

                // Get tree
                const treeResponse = await fetch(
                    `https://api.github.com/repos/${currentRepo.owner}/${currentRepo.repo}/git/trees/${branch}?recursive=1`,
                    { headers: getHeaders() }
                );

                if (!treeResponse.ok) {
                    throw new Error(`Failed to fetch tree: ${treeResponse.status}`);
                }

                const treeData = await treeResponse.json();
                const files = treeData.tree.filter(item => item.type === 'blob');
                
                log(`✓ Found ${files.length} files`);
                await saveToIndexedDB('metadata', { key: 'tree', value: treeData.tree });
                
                updateProgress(30, `Downloading ${files.length} files...`);

                // Download files
                let downloaded = 0;
                const batchSize = 10;
                
                for (let i = 0; i < files.length; i += batchSize) {
                    const batch = files.slice(i, Math.min(i + batchSize, files.length));
                    
                    await Promise.all(batch.map(async (file) => {
                        try {
                            const fileResponse = await fetch(
                                `https://api.github.com/repos/${currentRepo.owner}/${currentRepo.repo}/contents/${file.path}?ref=${branch}`,
                                { headers: getHeaders() }
                            );

                            if (fileResponse.ok) {
                                const fileData = await fileResponse.json();
                                await saveToIndexedDB('files', {
                                    path: file.path,
                                    content: fileData.content,
                                    encoding: fileData.encoding,
                                    size: fileData.size,
                                    sha: fileData.sha
                                });
                                downloaded++;
                            }
                        } catch (error) {
                            log(`⚠️  Failed: ${file.path}`, 'text-red-400');
                        }
                    }));

                    const progress = 30 + Math.floor((downloaded / files.length) * 60);
                    updateProgress(progress, `Downloaded ${downloaded}/${files.length} files`);
                }

                updateProgress(90, 'Saving metadata...');

                // Save metadata
                await saveToIndexedDB('metadata', {
                    key: 'currentRepo',
                    value: currentRepo
                });

                await saveToIndexedDB('metadata', {
                    key: 'userPermissions',
                    value: userPermissions
                });

                updateProgress(100, 'Complete!');
                
                log(`✓ Clone completed: ${downloaded} files downloaded`);
                showToast('Repository cloned successfully!', 'success');
                
                // Update UI
                updateRepositoryUI();
                loadFileTree();
                
                setTimeout(() => {
                    document.getElementById('cloneProgress').classList.add('hidden');
                }, 2000);

            } catch (error) {
                log(`✗ Error: ${error.message}`, 'text-red-400');
                showToast('Clone failed: ' + error.message, 'error');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        function updateProgress(percent, text) {
            document.getElementById('cloneProgressBar').style.width = percent + '%';
            document.getElementById('cloneProgressText').textContent = text;
        }

        async function updateRepositoryUI() {
            // Update topbar
            document.getElementById('repoBadge').textContent = `${currentRepo.owner}/${currentRepo.repo}`;
            document.getElementById('repoBadge').classList.remove('hidden');
            document.getElementById('downloadZipBtn').classList.remove('hidden');

            // Update stats
            const files = await getAllFromIndexedDB('files');
            const totalSize = files.reduce((sum, f) => sum + (f.size || 0), 0);
            
            document.getElementById('statFiles').textContent = files.length;
            document.getElementById('statSize').textContent = (totalSize / 1024).toFixed(2) + ' KB';
            document.getElementById('statsGrid').classList.remove('hidden');

            // Load additional stats
            loadCommits();
            loadBranches();
            loadRepoInfo(); // Load repo info for the info tab
        }

        // File Tree
        async function loadFileTree() {
            const tree = await getFromIndexedDB('metadata', 'tree');
            if (!tree) return;

            const treeContainer = document.getElementById('fileTree');
            treeContainer.innerHTML = '';

            const buildTree = (items) => {
                const structure = {};
                items.forEach(item => {
                    const parts = item.path.split('/');
                    let current = structure;
                    
                    parts.forEach((part, index) => {
                        if (!current[part]) {
                            current[part] = {
                                type: index === parts.length - 1 && item.type === 'blob' ? 'file' : 'folder',
                                path: item.path,
                                children: {}
                            };
                        }
                        current = current[part].children;
                    });
                });
                return structure;
            };

            const renderTree = (obj, container, level = 0) => {
                Object.keys(obj).sort().forEach(key => {
                    const item = obj[key];
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 py-2 px-3 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors tree-item';
                    div.style.paddingLeft = (level * 20 + 12) + 'px';
                    
                    if (item.type === 'file') {
                        div.innerHTML = `<i class="fas fa-file text-gray-400 text-xs"></i><span class="text-sm">${key}</span>`;
                        div.onclick = (e) => openFile(item.path, e);
                    } else {
                        div.innerHTML = `<i class="fas fa-folder text-yellow-500 text-xs"></i><span class="text-sm font-medium">${key}</span>`;
                        const childContainer = document.createElement('div');
                        div.onclick = (e) => {
                            e.stopPropagation();
                            const icon = div.querySelector('i');
                            if (childContainer.style.display === 'none') {
                                childContainer.style.display = 'block';
                                icon.classList.remove('fa-folder');
                                icon.classList.add('fa-folder-open');
                            } else {
                                childContainer.style.display = 'none';
                                icon.classList.remove('fa-folder-open');
                                icon.classList.add('fa-folder');
                            }
                        };
                        container.appendChild(div);
                        container.appendChild(childContainer);
                        renderTree(item.children, childContainer, level + 1);
                        return;
                    }
                    
                    container.appendChild(div);
                });
            };

            const structure = buildTree(tree.value);
            renderTree(structure, treeContainer);
        }

        // Monaco Editor
        function initMonacoEditor() {
            // FIX: Convert to a promise-based initializer to prevent race conditions
            if (monacoInitPromise) {
                return monacoInitPromise;
            }

            monacoInitPromise = new Promise((resolve, reject) => {
                const checkLoader = () => {
                    if (typeof require === 'undefined') {
                        // This handles if the loader.js itself is slow
                        setTimeout(checkLoader, 100);
                        return;
                    }

                    // Now we're safe to use require
                    require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
                    require(['vs/editor/editor.main'], function () {
                        try {
                            monacoEditor = monaco.editor.create(document.getElementById('editor'), {
                                value: '// Select a file from the tree to edit',
                                language: 'javascript',
                                theme: 'vs-dark',
                                automaticLayout: true,
                                fontSize: 14,
                                minimap: { enabled: true },
                                readOnly: !checkPermission('write')
                            });

                            monacoEditor.onDidChangeModelContent(() => {
                                if (currentFile && checkPermission('write')) {
                                    fileModified = true;
                                    document.getElementById('saveBtn').disabled = false;
                                    document.getElementById('commitBtn').disabled = false;
                                }
                            });
                            resolve(monacoEditor); // Resolve the promise
                        } catch (error) {
                            reject(error);
                        }
                    }, (error) => {
                        reject(error); // Handle require.js load error
                    });
                };
                checkLoader();
            });
            
            return monacoInitPromise;
        }
        

        async function openFile(path, e) {
            try {
                // FIX: Await the editor initialization
                if (!monacoEditor) {
                    showLoading('Loading Editor...', 'Just a moment');
                    // This will wait if it's still loading, or resolve instantly if already loaded
                    await initMonacoEditor(); 
                    hideLoading();
                }

                const file = await getFromIndexedDB('files', path);
                if (!file) {
                    showToast('File not found', 'error');
                    return;
                }

                currentFile = path;
                fileModified = false;

                const content = atob(file.content);
                const extension = path.split('.').pop();
                const languageMap = {
                    'js': 'javascript',
                    'ts': 'typescript',
                    'py': 'python',
                    'java': 'java',
                    'cpp': 'cpp',
                    'c': 'c',
                    'html': 'html',
                    'css': 'css',
                    'json': 'json',
                    'md': 'markdown',
                    'xml': 'xml',
                    'yaml': 'yaml',
                    'yml': 'yaml'
                };

                const language = languageMap[extension] || 'plaintext';
                
                // This code is now safe
                monaco.editor.setModelLanguage(monacoEditor.getModel(), language);
                monacoEditor.setValue(content);
                monacoEditor.updateOptions({ readOnly: !checkPermission('write') });
                
                document.getElementById('editorFilename').innerHTML = `
                    <i class="fas fa-file-code"></i>
                    <span>${path}</span>
                `;

                document.querySelectorAll('.tree-item').forEach(item => item.classList.remove('bg-indigo-100'));
                // FIX: Check if event target exists before using it
                if (e && e.target) {
                    e.target.closest('.tree-item').classList.add('bg-indigo-100');
                }
                
                const mode = checkPermission('write') ? '' : ' (read-only)';
                showToast('File loaded' + mode, 'info');

            } catch (error) {
                hideLoading();
                console.error("Failed to open file or load editor:", error);
                showToast('Failed to load editor. Please try again.', 'error');
            }
        }

        async function saveFile() {
            if (!currentFile || !fileModified) return;

            if (!checkPermission('write')) {
                showToast('Authentication required for write access', 'error');
                return;
            }

            try {
                const content = monacoEditor.getValue();
                const encoded = btoa(content);
                
                const file = await getFromIndexedDB('files', currentFile);
                file.content = encoded;
                file.size = new Blob([content]).size;
                
                await saveToIndexedDB('files', file);
                
                fileModified = false;
                document.getElementById('saveBtn').disabled = true;
                
                showToast('File saved locally', 'success');
                log(`✓ Saved: ${currentFile}`);
            } catch (error) {
                showToast('Save failed: ' + error.message, 'error');
            }
        }

        // Commit and Push
        function showCommitModal() {
            if (!checkPermission('write')) {
                showToast('Authentication required to push changes', 'error');
                return;
            }
            document.getElementById('commitModal').classList.remove('hidden');
            document.getElementById('commitModal').classList.add('flex');
        }

        function closeCommitModal() {
            document.getElementById('commitModal').classList.add('hidden');
            document.getElementById('commitModal').classList.remove('flex');
        }

        async function commitAndPush() {
            if (!checkPermission('write')) {
                showToast('Authentication required to push changes', 'error');
                return;
            }

            const message = document.getElementById('commitMessage').value.trim();
            if (!message) {
                showToast('Please enter a commit message', 'error');
                return;
            }

            closeCommitModal();
            showLoading('Committing changes...', 'Pushing to GitHub');

            try {
                if (!currentFile) {
                    throw new Error('No file selected');
                }

                const file = await getFromIndexedDB('files', currentFile);
                const content = file.content;

                // Get current file SHA from GitHub
                const getCurrentFile = await fetch(
                    `https://api.github.com/repos/${currentRepo.owner}/${currentRepo.repo}/contents/${currentFile}?ref=${currentRepo.branch}`,
                    { headers: getHeaders() }
                );

                let sha = file.sha;
                if (getCurrentFile.ok) {
                    const currentData = await getCurrentFile.json();
                    sha = currentData.sha;
                }

                // Push update
                const updateResponse = await fetch(
                    `https://api.github.com/repos/${currentRepo.owner}/${currentRepo.repo}/contents/${currentFile}`,
                    {
                        method: 'PUT',
                        headers: getHeaders(),
                        body: JSON.stringify({
                            message: message,
                            content: content,
                            sha: sha,
                            branch: currentRepo.branch
                        })
                    }
                );

                if (!updateResponse.ok) {
                    const error = await updateResponse.json();
                    throw new Error(error.message || 'Push failed');
                }

                const result = await updateResponse.json();
                
                // Update local SHA
                file.sha = result.content.sha;
                await saveToIndexedDB('files', file);

                fileModified = false;
                document.getElementById('commitBtn').disabled = true;
                
                showToast('Changes pushed successfully!', 'success');
                log(`✓ Pushed: ${currentFile}`);
                log(`  Commit: ${message}`);

            } catch (error) {
                showToast('Push failed: ' + error.message, 'error');
                log(`✗ Push failed: ${error.message}`, 'text-red-400');
            } finally {
                hideLoading();
            }
        }

        // Search Code (works without auth - searches local files)
        async function searchCode() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!query) {
                showToast('Please enter a search query', 'error');
                return;
            }

            showLoading('Searching...', 'Please wait');
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            try {
                const files = await getAllFromIndexedDB('files');
                let found = 0;

                for (const file of files) {
                    if (file.encoding !== 'base64') continue; // Only search text files
                    
                    const content = atob(file.content);
                    const lines = content.split('\n');
                    
                    // Search in filename
                    if (file.path.toLowerCase().includes(query)) {
                        addSearchResult(file.path, `Filename match`, file.path);
                        found++;
                    }

                    // Search in content
                    lines.forEach((line, index) => {
                        if (line.toLowerCase().includes(query)) {
                            const highlighted = line.replace(
                                new RegExp(query, 'gi'),
                                match => `<span class="bg-yellow-300 text-black px-1 rounded">${match}</span>`
                            );
                            addSearchResult(file.path, highlighted, `Line ${index + 1}`);
                            found++;
                        }
                    });
                }

                if (found === 0) {
                    resultsContainer.innerHTML = '<div class="text-center text-gray-400 py-8">No results found</div>';
                }

                showToast(`Found ${found} results`, 'success');
                log(`🔍 Search "${query}": ${found} results`);

            } catch (error) {
                showToast('Search failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function addSearchResult(filepath, content, lineInfo) {
            const resultsContainer = document.getElementById('searchResults');
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-md p-4 cursor-pointer hover:shadow-lg transition-shadow border-l-4 border-indigo-500';
            div.innerHTML = `
                <div class="flex items-center gap-2 font-medium text-gray-800 mb-2">
                    <i class="fas fa-file-code text-indigo-600"></i>
                    ${filepath}
                    <span class="text-xs text-gray-500 ml-2">${lineInfo}</span>
                </div>
                <div class="bg-gray-100 p-3 rounded font-mono text-sm text-gray-700 overflow-x-auto">${content}</div>
            `;
            div.onclick = () => {
                switchView('files');
                // Find the nav item for 'files' and click it to update the sidebar UI
                document.querySelector('.nav-item[onclick="switchView(\'files\')"]').classList.add('bg-indigo-600', 'border-indigo-500');
                document.querySelector('.nav-item[onclick="switchView(\'search\')"]').classList.remove('bg-indigo-600', 'border-indigo-500');
                
                setTimeout(() => openFile(filepath, null), 100); // Pass null for the event
            };
            resultsContainer.appendChild(div);
        }

        // Load Commits (works without auth for public repos)
        async function loadCommits() {
            if (!currentRepo.owner) return;

            try {
                const response = await fetch(
                    `https://api.github.com/repos/${currentRepo.owner}/${currentRepo.repo}/commits?per_page=30`,
                    { headers: getHeaders() }
                );

                if (!response.ok) throw new Error('Failed to load commits');

                const commits = await response.json();
                const container = document.getElementById('commitsList');
                container.innerHTML = '';

                document.getElementById('statCommits').textContent = '30+'; // GitHub API often paginates

                commits.forEach(commit => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-50 rounded-lg p-4 border-l-4 border-indigo-500';
                    div.innerHTML = `
                        <div class="flex items-center gap-2 font-medium text-gray-800 mb-2">
                            <i class="fas fa-code-commit text-indigo-600"></i>
                            ${commit.commit.message.split('\n')[0]}
                        </div>
                        <div class="text-sm text-gray-600 mb-1">
                            <strong>${commit.commit.author.name}</strong> committed on 
                            ${new Date(commit.commit.author.date).toLocaleString()}
                        </div>
                        <div class="font-mono text-xs text-gray-500">
                            ${commit.sha.substring(0, 7)}
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Failed to load commits:', error);
                document.getElementById('commitsList').innerHTML = `<p class="text-red-500">Failed to load commits.</p>`;
            }
        }

        // Load Branches (works without auth for public repos)
        async function loadBranches() {
            if (!currentRepo.owner) return;

            try {
                const response = await fetch(
                    `https://api.github.com/repos/${currentRepo.owner}/${currentRepo.repo}/branches`,
                    { headers: getHeaders() }
                );

                if (!response.ok) throw new Error('Failed to load branches');

                const branches = await response.json();
                const container = document.getElementById('branchesList');
                container.innerHTML = '';

                document.getElementById('statBranches').textContent = branches.length;

                branches.forEach(branch => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-50 rounded-lg p-4 border-l-4 border-indigo-500';
                    const isCurrent = branch.name === currentRepo.branch;
                    div.innerHTML = `
                        <div class="flex items-center gap-2 font-medium text-gray-800 mb-2">
                            <i class="fas fa-code-branch text-indigo-600"></i>
                            ${branch.name}
                            ${isCurrent ? '<span class="bg-indigo-600 text-white px-2 py-1 rounded text-xs ml-2">current</span>' : ''}
                        </div>
                        <div class="font-mono text-xs text-gray-500">
                            ${branch.commit.sha.substring(0, 7)}
                        </div>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Failed to load branches:', error);
                document.getElementById('branchesList').innerHTML = `<p class="text-red-500">Failed to load branches.</p>`;
            }
        }

        // Load Collaborators (requires auth)
        async function loadCollaborators() {
            if (!currentRepo.owner) {
                showToast('Please clone a repository first', 'error');
                return;
            }

            if (!userPermissions.authenticated) {
                showToast('Authentication required to view collaborators', 'warning');
                return;
            }

            showLoading('Loading collaborators...', 'Please wait');

            try {
                const response = await fetch(
                    `https://api.github.com/repos/${currentRepo.owner}/${currentRepo.repo}/collaborators`,
                    { headers: getHeaders() }
                );

                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('You need admin access to view collaborators');
                    }
                    throw new Error('Failed to load collaborators');
                }

                const collaborators = await response.json();
                const container = document.getElementById('collaboratorsList');
                container.innerHTML = '';

                if (collaborators.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-4">No collaborators found</div>';
                } else {
                    collaborators.forEach(collab => {
                        const div = document.createElement('div');
                        div.className = 'bg-gray-50 rounded-lg p-4 flex items-center justify-between mb-3';
                        div.innerHTML = `
                            <div class="flex items-center gap-3">
                                <img src="${collab.avatar_url}" class="w-10 h-10 rounded-full" alt="${collab.login}">
                                <div>
                                    <div class="font-medium text-gray-800">${collab.login}</div>
                                    <div class="text-sm text-gray-600">${collab.permissions?.admin ? 'Admin' : collab.permissions?.push ? 'Write' : 'Read'}</div>
                                </div>
                            </div>
                            <a href="${collab.html_url}" target="_blank" class="text-indigo-600 hover:text-indigo-700">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                        `;
                        container.appendChild(div);
                    });
                }

                showToast('Collaborators loaded', 'success');

            } catch (error) {
                showToast('Failed to load collaborators: ' + error.message, 'error');
                document.getElementById('collaboratorsList').innerHTML = `
                    <div class="text-center text-red-500 py-4">
                        <i class="fas fa-exclamation-circle mb-2"></i>
                        <div>${error.message}</div>
                    </div>
                `;
            } finally {
                hideLoading();
            }
        }

        // Download as ZIP (works without auth)
        async function downloadAsZip() {
            if (typeof JSZip === 'undefined' || typeof saveAs === 'undefined') {
                showToast('Download libraries are missing', 'error');
                console.error('JSZip or FileSaver is not loaded');
                return;
            }

            showLoading('Creating ZIP...', 'This may take a moment');

            try {
                const files = await getAllFromIndexedDB('files');
                const zip = new JSZip();

                files.forEach(file => {
                    // Only zip files that are base64 (text), skip binary/unsupported
                    if (file.encoding === 'base64') {
                        const content = atob(file.content);
                        zip.file(file.path, content);
                    }
                });

                const blob = await zip.generateAsync({ type: 'blob' });
                saveAs(blob, `${currentRepo.owner}-${currentRepo.repo}.zip`);

                showToast('ZIP downloaded successfully!', 'success');
                log(`✓ Downloaded ZIP: ${files.length} files`);

            } catch (error) {
                showToast('ZIP creation failed: ' + error.message, 'error');
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        // Settings
        async function saveSettings() {
            const userName = document.getElementById('gitUserName').value.trim();
            const userEmail = document.getElementById('gitUserEmail').value.trim();

            await saveToIndexedDB('metadata', {
                key: 'gitConfig',
                value: { name: userName, email: userEmail }
            });

            showToast('Settings saved', 'success');
        }

        async function showStorageInfo() {
            try {
                const files = await getAllFromIndexedDB('files');
                const metadata = await getAllFromIndexedDB('metadata');
                
                const totalSize = files.reduce((sum, f) => sum + (f.size || 0), 0);
                
                const info = document.getElementById('storageInfo');
                info.textContent = `
    Files stored: ${files.length}
    Metadata entries: ${metadata.length}
    Total size: ${(totalSize / 1024 / 1024).toFixed(2)} MB
    Database: IndexedDB
    Authentication: ${userPermissions.authenticated ? 'Active' : 'Not active'}
                `;
            } catch (error) {
                console.error("Could not get storage info", error);
                document.getElementById('storageInfo').textContent = "Could not calculate storage info.";
            }
        }

        async function clearAllData() {
            if (!confirm('This will delete all cloned repositories and settings. Continue?')) {
                return;
            }

            showLoading('Clearing data...', 'Please wait');

            try {
                await clearIndexedDB('files');
                await clearIndexedDB('metadata');

                currentRepo = { owner: '', repo: '', branch: '', token: '' };
                currentFile = null;
                fileModified = false;
                userPermissions = { permission: 'none', canPush: false, canPull: true, isOwner: false, username: '', authenticated: false };

                document.getElementById('repoBadge').classList.add('hidden');
                document.getElementById('downloadZipBtn').classList.add('hidden');
                document.getElementById('statsGrid').classList.add('hidden');
                document.getElementById('fileTree').innerHTML = '<div class="text-center text-gray-400 py-8">Clone a repository first</div>';
                document.getElementById('consoleOutput').textContent = '';
                document.getElementById('permissionBadge').innerHTML = '';
                document.getElementById('authStatus').innerHTML = '';
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('tokenInput').value = '';

                if (monacoEditor) {
                    monacoEditor.setValue('// Select a file from the tree to edit');
                }

                showToast('All data cleared', 'success');
                log('🗑️  All data cleared');

            } catch (error) {
                showToast('Clear failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Load repository info (works without auth for public repos)
        async function loadRepoInfo() {
            const repoInfo = await getFromIndexedDB('metadata', 'repoInfo');
            if (!repoInfo) {
                document.getElementById('infoOutput').textContent = "No repository info found. Clone a repository first.";
                return;
            }

            const info = repoInfo.value;
            const output = document.getElementById('infoOutput');
            output.textContent = `
Repository Information
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Name: ${info.name}
Full Name: ${info.full_name}
Description: ${info.description || 'N/A'}
Owner: ${info.owner.login}
Private: ${info.private ? 'Yes' : 'No'}
Default Branch: ${info.default_branch}

Created: ${new Date(info.created_at).toLocaleString()}
Updated: ${new Date(info.updated_at).toLocaleString()}
Pushed: ${new Date(info.pushed_at).toLocaleString()}

Stars: ⭐ ${info.stargazers_count}
Forks: 🍴 ${info.forks_count}
Watchers: 👀 ${info.watchers_count}
Open Issues: 🐛 ${info.open_issues_count}

Size: ${(info.size / 1024).toFixed(2)} MB
Language: ${info.language || 'N/A'}
License: ${info.license?.name || 'N/A'}

Homepage: ${info.homepage || 'N/A'}
Clone URL: ${info.clone_url}
            `;
        }

        // Initialize
        window.addEventListener('load', async () => {
            try {
                await initDB();
                
                // Load saved repo
                const savedRepo = await getFromIndexedDB('metadata', 'currentRepo');
                if (savedRepo) {
                    currentRepo = savedRepo.value;
                    document.getElementById('tokenInput').value = currentRepo.token || '';
                    document.getElementById('repoInput').value = `${currentRepo.owner}/${currentRepo.repo}`;
                    document.getElementById('branchInput').value = currentRepo.branch;
                    
                    // Load saved permissions
                    const savedPerms = await getFromIndexedDB('metadata', 'userPermissions');
                    if (savedPerms) {
                        userPermissions = savedPerms.value;
                        updatePermissionUI();
                    }
                    
                    await updateRepositoryUI();
                    await loadFileTree();
                    
                    log('✓ Loaded cached repository');
                }

                // Load settings
                const gitConfig = await getFromIndexedDB('metadata', 'gitConfig');
                if (gitConfig) {
                    document.getElementById('gitUserName').value = gitConfig.value.name;
                    document.getElementById('gitUserEmail').value = gitConfig.value.email;
                }

                showStorageInfo();
                
                log('🚀 GitHub Pro Client Ready!');
                log('💡 No token needed for public repos');
                log('🔑 Add token for private repos and push access');
                
                // FIX: Start pre-loading the editor in the background
                initMonacoEditor().catch(error => {
                    console.error('Monaco editor failed to load', error);
                    showToast('Code editor failed to load', 'error');
                });
                
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Initialization failed: ' + error.message, 'error');
            }
        });
    </script>
</body>
</html>
