<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Pro Client - Multi-User</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        'primary-dark': '#4f46e5',
                        secondary: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .spinner { animation: spin 1s linear infinite; }
        .toast { animation: slideIn 0.3s ease; }
        .progress-shimmer::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }
        #editor {
            height: 100%;
            min-height: 500px;
        }
        .file-modified-indicator {
            color: #eab308;
            font-weight: bold;
            margin-left: 8px;
            font-size: 0.75rem;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500">
    <div class="flex h-screen overflow-hidden">
        <div class="w-72 bg-gray-900 text-white flex flex-col shadow-2xl">
            <div class="p-6 bg-gray-800 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <i class="fab fa-github text-3xl text-indigo-400"></i>
                    <span class="text-xl font-bold">GitHub Pro</span>
                </div>
                <div class="mt-3" id="permissionBadge"></div>
                <div class="mt-2" id="authStatus"></div>
            </div>
            
            <nav class="flex-1 overflow-y-auto py-4">
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500 active" onclick="switchView('repo')">
                    <i class="fas fa-database w-5"></i>
                    <span>Repository</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('files')">
                    <i class="fas fa-folder w-5"></i>
                    <span>Repo Explorer</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('source-control')">
                    <i class="fas fa-code-branch w-5"></i>
                    <span>Source Control</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('search')">
                    <i class="fas fa-search w-5"></i>
                    <span>Search Code</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('commits')">
                    <i class="fas fa-code-commit w-5"></i>
                    <span>Commits</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('branches')">
                    <i class="fas fa-code-branch w-5"></i>
                    <span>Branches</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('info')">
                    <i class="fas fa-info-circle w-5"></i>
                    <span>Repository Info</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('permissions')">
                    <i class="fas fa-user-shield w-5"></i>
                    <span>Permissions</span>
                </div>
                <div class="nav-item flex items-center gap-3 px-6 py-3 cursor-pointer hover:bg-gray-800 transition-colors border-l-4 border-transparent hover:border-indigo-500" onclick="switchView('settings')">
                    <i class="fas fa-cog w-5"></i>
                    <span>Settings</span>
                </div>
            </nav>
        </div>

        <div class="flex-1 flex flex-col bg-gray-50 overflow-hidden">
            <div class="bg-white shadow-md px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-semibold text-gray-800" id="topbarTitle">GitHub Pro Client</h1>
                    <span class="hidden bg-indigo-600 text-white px-3 py-1 rounded-full text-sm font-medium" id="repoBadge"></span>
                    <span class="hidden text-sm text-gray-600" id="userInfo"></span>
                </div>
                <div class="flex gap-3">
                    <button class="hidden bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2" onclick="downloadAsZip()" id="downloadZipBtn">
                        <i class="fas fa-download"></i> Download ZIP
                    </button>
                    <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2" onclick="clearAllData()">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto overflow-x-hidden">
                <div class="view-container p-6" id="view-repo">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-database text-indigo-600"></i>
                            Repository Management
                        </h2>
                        
                        <div class="mb-5">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-key"></i> GitHub Personal Access Token (Optional for public repos)
                            </label>
                            <div class="flex gap-2">
                                <input type="password" id="tokenInput" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx (leave empty for public repos)">
                                <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg font-medium transition-colors" onclick="updateToken()">
                                    <i class="fas fa-sync"></i> Update
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Token needed for: private repos, pushing changes, higher API rate limits
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fab fa-github"></i> Repository URL or Owner/Repo
                                </label>
                                <input type="text" id="repoInput" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors" placeholder="owner/repo">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-code-branch"></i> Branch
                                </label>
                                <select id="branchSelect" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors">
                                    <option value="">Select a repository first</option>
                                </select>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button id="syncButton" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2" onclick="syncMetadata()">
                                <i class="fas fa-sync"></i> Sync Repository Info
                            </button>
                            <button id="cloneButton" class="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2" onclick="cloneRepository()">
                                <i class="fas fa-download"></i> Clone Repository
                            </button>
                        </div>

                        <div id="cloneProgress" class="hidden mt-6 bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-gray-700" id="cloneProgressText">Preparing...</span>
                                <span class="text-sm text-gray-500" id="cloneProgressPercent">0%</span>
                            </div>
                            <div class="relative h-3 bg-gray-200 rounded-full overflow-hidden">
                                <div id="cloneProgressBar" class="absolute inset-y-0 left-0 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-300 progress-shimmer" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div id="statsGrid" class="hidden grid grid-cols-3 gap-4">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file-code text-2xl text-indigo-600"></i>
                                </div>
                                <div>
                                    <p class="text-gray-500 text-sm">Files</p>
                                    <p class="text-2xl font-bold text-gray-800" id="statFiles">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-hdd text-2xl text-purple-600"></i>
                                </div>
                                <div>
                                    <p class="text-gray-500 text-sm">Total Size</p>
                                    <p class="text-2xl font-bold text-gray-800" id="statSize">0 KB</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-pink-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-code-branch text-2xl text-pink-600"></i>
                                </div>
                                <div>
                                    <p class="text-gray-500 text-sm">Branches</p>
                                    <p class="text-2xl font-bold text-gray-800" id="statBranches">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-files">
                    <div class="grid grid-cols-2 gap-6 h-full">
                        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-folder-tree text-indigo-600"></i>
                                File Tree
                            </h2>
                            <div id="fileTree" class="flex-1 overflow-y-auto text-sm font-mono"></div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <i class="fas fa-code text-purple-600"></i>
                                <span id="editorFileName">Select a file</span>
                            </h2>
                            <div id="editor" class="flex-1 border border-gray-200 rounded-lg overflow-hidden"></div>
                            <div class="mt-4 flex gap-2">
                                <button id="saveFileBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2" disabled onclick="saveFileChanges()">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button id="discardBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2" disabled onclick="discardFileChanges()">
                                    <i class="fas fa-times"></i> Discard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-source-control">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-code-branch text-indigo-600"></i>
                            Source Control
                        </h2>
                        
                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-3">Modified Files</h3>
                            <div id="modifiedFilesList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                        </div>

                        <div class="border-t pt-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-message"></i> Commit Message
                            </label>
                            <textarea id="commitMessage" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors" rows="4" placeholder="Describe your changes..."></textarea>
                            <button id="commitButton" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2" onclick="commitChanges()">
                                <i class="fas fa-check"></i> Commit & Push
                            </button>
                        </div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-search">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-search text-indigo-600"></i>
                            Search Code
                        </h2>
                        
                        <div class="mb-5">
                            <input type="text" id="searchInput" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors" placeholder="Search in repository...">
                        </div>
                        
                        <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2" onclick="searchFiles()">
                            <i class="fas fa-search"></i> Search
                        </button>

                        <div id="searchResults" class="mt-6"></div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-commits">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-code-commit text-indigo-600"></i>
                            Recent Commits
                        </h2>
                        <div id="commitsList" class="space-y-4"></div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-branches">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-code-branch text-indigo-600"></i>
                            Branches
                        </h2>
                        <div id="branchesList" class="space-y-3"></div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-info">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-info-circle text-indigo-600"></i>
                            Repository Information
                        </h2>
                        <pre id="infoOutput" class="text-sm text-gray-700 whitespace-pre-wrap font-mono bg-gray-50 p-4 rounded-lg overflow-x-auto"></pre>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-permissions">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-user-shield text-indigo-600"></i>
                            User Permissions
                        </h2>
                        <div id="permissionsInfo" class="space-y-4">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-2">Authentication Status:</p>
                                <p class="font-semibold text-gray-800" id="permAuthStatus">Not authenticated</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-2">Username:</p>
                                <p class="font-semibold text-gray-800" id="permUsername">-</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-2">Repository Permission:</p>
                                <p class="font-semibold text-gray-800" id="permLevel">-</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-2">Can Push:</p>
                                <p class="font-semibold text-gray-800" id="permCanPush">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="view-container hidden p-6" id="view-settings">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                            <i class="fas fa-cog text-indigo-600"></i>
                            Settings
                        </h2>
                        
                        <div class="space-y-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-user"></i> Git User Name
                                </label>
                                <input type="text" id="gitUserName" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors" placeholder="Your Name">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-envelope"></i> Git User Email
                                </label>
                                <input type="email" id="gitUserEmail" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors" placeholder="your.email@example.com">
                            </div>
                        </div>

                        <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2 mb-6" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>

                        <div class="border-t pt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Storage Information</h3>
                            <pre id="storageInfo" class="text-sm text-gray-700 whitespace-pre-wrap font-mono bg-gray-50 p-4 rounded-lg"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="flex flex-col items-center">
                <div class="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full spinner mb-4"></div>
                <p class="text-lg font-semibold text-gray-800 mb-2" id="loadingTitle">Processing...</p>
                <p class="text-sm text-gray-600" id="loadingText"></p>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="fixed bottom-6 right-6 z-50 space-y-2"></div>

    <!-- Load JSZip and FileSaver BEFORE Monaco to prevent AMD conflicts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Prevent FileSaver from using AMD/define
        window.define_backup = window.define;
        window.define = undefined;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // Restore define for Monaco
        window.define = window.define_backup;
        window.define_backup = undefined;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <script>
        // --- Global State ---
        
        let db;
        let currentRepo = { owner: '', repo: '', branch: 'main', token: '' };
        let userPermissions = {
            authenticated: false,
            username: 'Anonymous',
            permission: 'read',
            canPush: false
        };
        let monacoEditor = null;
        let currentFile = null;
        let fileTreeData = null;

        // --- IndexedDB Setup (Version 6 - Complete Rewrite) ---

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('GitHubProDB', 6);
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                
                request.onerror = (event) => {
                    reject(new Error('Failed to open database: ' + event.target.error));
                };
                
                request.onupgradeneeded = (event) => {
                    log('Database schema upgrade to v6...');
                    const db = event.target.result;
                    const transaction = event.target.transaction;
                    
                    // Delete old stores if they exist
                    if (db.objectStoreNames.contains('files')) {
                        db.deleteObjectStore('files');
                        log('  > Deleted old "files" store');
                    }
                    if (db.objectStoreNames.contains('metadata')) {
                        db.deleteObjectStore('metadata');
                        log('  > Deleted old "metadata" store');
                    }
                    
                    // Create fresh stores
                    const fileStore = db.createObjectStore('files', { keyPath: 'path' });
                    fileStore.createIndex('isDirty', 'isDirty', { unique: false });
                    log('  > Created new "files" store with isDirty index');
                    
                    db.createObjectStore('metadata', { keyPath: 'key' });
                    log('  > Created new "metadata" store');
                    
                    log('Database v6 upgrade complete - clean slate');
                };
            });
        }

        async function saveToIndexedDB(storeName, data) {
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.put(data);
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function getFromIndexedDB(storeName, key) {
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function getAllFromIndexedDB(storeName) {
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function clearIndexedDB(storeName) {
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Completely rewritten getDirtyFiles with bulletproof error handling
        async function getDirtyFiles() {
            try {
                // Method 1: Try using the index (fastest)
                return await new Promise((resolve, reject) => {
                    try {
                        const transaction = db.transaction(['files'], 'readonly');
                        const store = transaction.objectStore('files');
                        
                        if (store.indexNames.contains('isDirty')) {
                            const index = store.index('isDirty');
                            const request = index.getAll(true);
                            
                            request.onsuccess = () => resolve(request.result || []);
                            request.onerror = () => {
                                // If index fails, fall back to manual filtering
                                reject(new Error('Index query failed'));
                            };
                        } else {
                            reject(new Error('Index not found'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                });
            } catch (indexError) {
                console.log('Index method failed, using fallback:', indexError.message);
                
                // Method 2: Fallback - get all files and filter manually
                try {
                    const allFiles = await getAllFromIndexedDB('files');
                    return allFiles.filter(file => file.isDirty === true);
                } catch (fallbackError) {
                    console.error('Fallback method also failed:', fallbackError);
                    return []; // Return empty array as last resort
                }
            }
        }

        // --- Auth & Permissions ---

        function hasToken() {
            return currentRepo.token && currentRepo.token.trim() !== '';
        }

        async function updateToken() {
            const newToken = document.getElementById('tokenInput').value.trim();
            currentRepo.token = newToken;
            
            if (currentRepo.owner && currentRepo.repo) {
                await saveToIndexedDB('metadata', {
                    key: 'currentRepo',
                    value: currentRepo
                });
                
                if (hasToken()) {
                    showLoading('Checking permissions...', 'Please wait');
                    await checkUserPermissions();
                    hideLoading();
                    showToast('Token updated and permissions refreshed', 'success');
                } else {
                    userPermissions.authenticated = false;
                    userPermissions.canPush = false;
                    userPermissions.permission = 'read';
                    userPermissions.username = 'Anonymous';
                    updatePermissionUI();
                    showToast('Token removed - using public access mode', 'info');
                }
            } else {
                showToast('Token saved. Select a repository to check permissions.', 'info');
            }
        }

        async function checkUserPermissions() {
            if (!hasToken()) {
                userPermissions.authenticated = false;
                userPermissions.canPush = false;
                userPermissions.permission = 'read';
                userPermissions.username = 'Anonymous';
                updatePermissionUI();
                return;
            }

            try {
                const userResponse = await githubFetch('/user');
                userPermissions.username = userResponse.login;
                userPermissions.authenticated = true;

                try {
                    const repoResponse = await githubFetch(`/repos/${currentRepo.owner}/${currentRepo.repo}`);
                    const permissions = repoResponse.permissions || {};
                    
                    if (permissions.admin) {
                        userPermissions.permission = 'admin';
                        userPermissions.canPush = true;
                    } else if (permissions.push) {
                        userPermissions.permission = 'write';
                        userPermissions.canPush = true;
                    } else {
                        userPermissions.permission = 'read';
                        userPermissions.canPush = false;
                    }
                } catch (repoError) {
                    userPermissions.permission = 'read';
                    userPermissions.canPush = false;
                }

                await saveToIndexedDB('metadata', {
                    key: 'userPermissions',
                    value: userPermissions
                });

                updatePermissionUI();
                log(`âœ“ User: ${userPermissions.username}`);
                log(`âœ“ Permission level: ${userPermissions.permission}`);
            } catch (error) {
                userPermissions.authenticated = false;
                userPermissions.canPush = false;
                userPermissions.permission = 'invalid';
                userPermissions.username = 'Invalid Token';
                updatePermissionUI();
                showToast('Invalid token or insufficient permissions', 'error');
            }
        }

        function updatePermissionUI() {
            const badge = document.getElementById('permissionBadge');
            const authStatus = document.getElementById('authStatus');
            
            if (userPermissions.authenticated) {
                badge.innerHTML = `<span class="inline-flex items-center gap-1 bg-emerald-500 text-white text-xs px-2 py-1 rounded">
                    <i class="fas fa-shield-alt"></i> ${userPermissions.permission}
                </span>`;
                authStatus.innerHTML = `<span class="text-xs text-gray-300">
                    <i class="fas fa-user"></i> ${userPermissions.username}
                </span>`;
            } else {
                badge.innerHTML = `<span class="inline-flex items-center gap-1 bg-gray-500 text-white text-xs px-2 py-1 rounded">
                    <i class="fas fa-eye"></i> read-only
                </span>`;
                authStatus.innerHTML = `<span class="text-xs text-gray-300">
                    <i class="fas fa-globe"></i> Public access
                </span>`;
            }

            document.getElementById('permAuthStatus').textContent = userPermissions.authenticated ? 'Authenticated' : 'Not authenticated';
            document.getElementById('permUsername').textContent = userPermissions.username;
            document.getElementById('permLevel').textContent = userPermissions.permission;
            document.getElementById('permCanPush').textContent = userPermissions.canPush ? 'Yes' : 'No';
            document.getElementById('userInfo').textContent = userPermissions.authenticated ? userPermissions.username : '';
            
            if (userPermissions.authenticated) {
                document.getElementById('userInfo').classList.remove('hidden');
            }
        }

        // --- GitHub API (with CORS-friendly approach) ---

        async function githubFetch(endpoint, options = {}) {
            const headers = {
                'Accept': 'application/vnd.github.v3+json'
            };

            // Only add Authorization header if we have a token
            // This reduces CORS preflight issues
            if (hasToken()) {
                headers['Authorization'] = `token ${currentRepo.token}`;
            }

            const config = {
                ...options,
                headers: { ...headers, ...(options.headers || {}) }
            };

            const response = await fetch(`https://api.github.com${endpoint}`, config);

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
            }

            return await response.json();
        }

        // --- UI Functions ---

        function switchView(view) {
            document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'border-indigo-500'));
            
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const onclick = item.getAttribute('onclick');
                if (onclick && onclick.includes(`'${view}'`)) {
                    item.classList.add('active', 'border-indigo-500');
                }
            });

            if (view === 'source-control') {
                loadModifiedFilesList();
            } else if (view === 'settings') {
                showStorageInfo();
            }
        }

        function showLoading(title, text = '') {
            document.getElementById('loadingTitle').textContent = title;
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-emerald-500',
                error: 'bg-red-500',
                info: 'bg-indigo-500',
                warning: 'bg-yellow-500'
            };

            toast.className = `toast ${colors[type] || colors.info} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px]`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} text-xl"></i>
                <span>${message}</span>
            `;

            container.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function log(message, colorClass = 'text-gray-300') {
            console.log(message);
        }

        // --- Repository Management ---

        async function syncMetadata() {
            const repoInput = document.getElementById('repoInput').value.trim();
            if (!repoInput) {
                showToast('Please enter a repository', 'warning');
                return;
            }

            const match = repoInput.match(/(?:https?:\/\/github\.com\/)?([^\/]+)\/([^\/]+)/);
            if (!match) {
                showToast('Invalid repository format', 'error');
                return;
            }

            currentRepo.owner = match[1];
            currentRepo.repo = match[2].replace(/\.git$/, '');
            currentRepo.token = document.getElementById('tokenInput').value.trim();

            showLoading('Syncing repository...', 'Fetching metadata');
            
            try {
                await checkUserPermissions();
                
                const repoData = await githubFetch(`/repos/${currentRepo.owner}/${currentRepo.repo}`);
                currentRepo.branch = repoData.default_branch;

                await saveToIndexedDB('metadata', {
                    key: 'repoInfo',
                    value: repoData
                });

                const branches = await githubFetch(`/repos/${currentRepo.owner}/${currentRepo.repo}/branches`);
                const branchSelect = document.getElementById('branchSelect');
                branchSelect.innerHTML = branches.map(b => 
                    `<option value="${b.name}" ${b.name === currentRepo.branch ? 'selected' : ''}>${b.name}</option>`
                ).join('');

                await saveToIndexedDB('metadata', {
                    key: 'currentRepo',
                    value: currentRepo
                });

                showToast(`Synced ${currentRepo.owner}/${currentRepo.repo}`, 'success');
                log(`âœ“ Synced: ${currentRepo.owner}/${currentRepo.repo}`);
            } catch (error) {
                showToast('Sync failed: ' + error.message, 'error');
                log(`âœ— Sync error: ${error.message}`, 'text-red-400');
            } finally {
                hideLoading();
            }
        }

        async function cloneRepository() {
            if (!currentRepo.owner || !currentRepo.repo) {
                showToast('Sync repository first', 'warning');
                return;
            }

            const selectedBranch = document.getElementById('branchSelect').value;
            currentRepo.branch = selectedBranch;

            showLoading('Cloning repository...', 'This may take a moment');
            document.getElementById('cloneProgress').classList.remove('hidden');

            try {
                log(`ðŸš€ Starting clone: ${currentRepo.owner}/${currentRepo.repo}`);
                log(`ðŸ“ Branch: ${currentRepo.branch}`);
                
                updateCloneProgress('Fetching file tree...', 10);

                // Use recursive tree API
                const treeResponse = await githubFetch(`/repos/${currentRepo.owner}/${currentRepo.repo}/git/trees/${currentRepo.branch}?recursive=1`);
                const files = treeResponse.tree.filter(item => item.type === 'blob');
                
                log(`âœ“ Found ${files.length} files`);

                await saveToIndexedDB('metadata', {
                    key: 'tree',
                    value: treeResponse.tree
                });

                updateCloneProgress('Downloading files...', 30);

                let downloaded = 0;
                const batchSize = 5; // Reduced batch size for better reliability
                
                for (let i = 0; i < files.length; i += batchSize) {
                    const batch = files.slice(i, Math.min(i + batchSize, files.length));
                    
                    // Use Promise.allSettled to handle failures gracefully
                    const results = await Promise.allSettled(batch.map(async (file) => {
                        try {
                            // Use blob API which is more reliable and has better CORS support
                            const blobResponse = await githubFetch(`/repos/${currentRepo.owner}/${currentRepo.repo}/git/blobs/${file.sha}`);
                            
                            await saveToIndexedDB('files', {
                                path: file.path,
                                content: blobResponse.content,
                                encoding: blobResponse.encoding,
                                size: file.size,
                                sha: file.sha,
                                isDirty: false
                            });
                            
                            return { success: true, path: file.path };
                        } catch (error) {
                            log(`âš ï¸  Failed: ${file.path} - ${error.message}`, 'text-red-400');
                            return { success: false, path: file.path, error: error.message };
                        }
                    }));

                    // Count successful downloads
                    const successCount = results.filter(r => r.status === 'fulfilled' && r.value.success).length;
                    downloaded += successCount;

                    const progress = 30 + Math.floor((downloaded / files.length) * 60);
                    updateCloneProgress(`Downloaded ${downloaded}/${files.length} files`, progress);
                }

                log(`âœ“ Clone completed: ${downloaded} files downloaded`);
                updateCloneProgress('Finalizing...', 95);

                await updateRepositoryUI();
                await loadFileTree();
                
                updateCloneProgress('Complete!', 100);
                setTimeout(() => {
                    document.getElementById('cloneProgress').classList.add('hidden');
                    showToast(`Repository cloned! ${downloaded} files downloaded`, downloaded === files.length ? 'success' : 'warning');
                }, 1000);
            } catch (error) {
                showToast('Clone failed: ' + error.message, 'error');
                log(`âœ— Error: ${error.message}`, 'text-red-400');
            } finally {
                hideLoading();
            }
        }

        function updateCloneProgress(text, percent) {
            document.getElementById('cloneProgressText').textContent = text;
            document.getElementById('cloneProgressPercent').textContent = `${percent}%`;
            document.getElementById('cloneProgressBar').style.width = `${percent}%`;
        }

        async function updateRepositoryUI() {
            document.getElementById('repoBadge').textContent = `${currentRepo.owner}/${currentRepo.repo}`;
            document.getElementById('repoBadge').classList.remove('hidden');
            document.getElementById('downloadZipBtn').classList.remove('hidden');

            const files = await getAllFromIndexedDB('files');
            const totalSize = files.reduce((sum, f) => sum + (f.size || 0), 0);
            
            document.getElementById('statFiles').textContent = files.length;
            document.getElementById('statSize').textContent = (totalSize / 1024).toFixed(2) + ' KB';
            document.getElementById('statsGrid').classList.remove('hidden');

            await loadCommits();
            await loadBranches();
            await loadRepoInfo();
        }

        // --- File Tree & Editor ---

        async function loadFileTree() {
            const treeData = await getFromIndexedDB('metadata', 'tree');
            if (!treeData || !treeData.value) {
                document.getElementById('fileTree').innerHTML = '<div class="text-center text-gray-400 py-8">Clone a repository first</div>';
                return;
            }
            
            const dirtyFiles = await getDirtyFiles();
            const dirtyPaths = new Set(dirtyFiles.map(f => f.path));

            const treeContainer = document.getElementById('fileTree');
            treeContainer.innerHTML = '';

            const buildTree = (items) => {
                const structure = {};
                
                items.forEach(item => {
                    if (item.type === 'blob') {
                        const parts = item.path.split('/');
                        let current = structure;
                        
                        parts.forEach((part, index) => {
                            if (index === parts.length - 1) {
                                current[part] = { type: 'file', path: item.path };
                            } else {
                                current[part] = current[part] || { type: 'dir', children: {} };
                                current = current[part].children;
                            }
                        });
                    }
                });
                
                return structure;
            };

            const renderTree = (node, level = 0) => {
                const container = document.createElement('div');
                
                Object.entries(node).sort(([a, objA], [b, objB]) => {
                    if (objA.type === objB.type) return a.localeCompare(b);
                    return objA.type === 'dir' ? -1 : 1;
                }).forEach(([name, obj]) => {
                    const item = document.createElement('div');
                    item.style.paddingLeft = (level * 16) + 'px';
                    item.className = 'py-1 px-2 hover:bg-gray-100 cursor-pointer rounded flex items-center gap-2';
                    
                    if (obj.type === 'dir') {
                        item.innerHTML = `<i class="fas fa-folder text-yellow-500"></i> <span>${name}</span>`;
                        item.onclick = () => {
                            const children = item.nextElementSibling;
                            if (children && children.classList.contains('tree-children')) {
                                children.classList.toggle('hidden');
                                item.querySelector('i').classList.toggle('fa-folder');
                                item.querySelector('i').classList.toggle('fa-folder-open');
                            }
                        };
                        container.appendChild(item);
                        
                        const children = document.createElement('div');
                        children.className = 'tree-children';
                        children.appendChild(renderTree(obj.children, level + 1));
                        container.appendChild(children);
                    } else {
                        const isDirty = dirtyPaths.has(obj.path);
                        item.innerHTML = `
                            <i class="fas fa-file-code text-indigo-500"></i> 
                            <span>${name}</span>
                            ${isDirty ? '<span class="file-modified-indicator">â—</span>' : ''}
                        `;
                        item.onclick = () => openFile(obj.path);
                        container.appendChild(item);
                    }
                });
                
                return container;
            };

            const tree = buildTree(treeData.value);
            treeContainer.appendChild(renderTree(tree));
        }

        async function openFile(path) {
            const file = await getFromIndexedDB('files', path);
            if (!file) {
                showToast('File not found', 'error');
                return;
            }

            currentFile = file;
            document.getElementById('editorFileName').innerHTML = `<i class="fas fa-file-code"></i> ${path}`;

            if (!monacoEditor) {
                await initMonacoEditor();
            }

            const content = file.encoding === 'base64' ? atob(file.content) : file.content;
            const language = detectLanguage(path);
            
            monaco.editor.setModelLanguage(monacoEditor.getModel(), language);
            monacoEditor.setValue(content);
            monacoEditor.getModel().setValue(content);

            document.getElementById('saveFileBtn').disabled = true;
            document.getElementById('discardBtn').disabled = true;
        }

        async function initMonacoEditor() {
            return new Promise((resolve, reject) => {
                require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
                require(['vs/editor/editor.main'], function () {
                    monacoEditor = monaco.editor.create(document.getElementById('editor'), {
                        value: '// Select a file to edit',
                        language: 'javascript',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        minimap: { enabled: false }
                    });

                    monacoEditor.onDidChangeModelContent(() => {
                        if (currentFile) {
                            const enabled = monacoEditor.getValue() !== (currentFile.encoding === 'base64' ? atob(currentFile.content) : currentFile.content);
                            document.getElementById('saveFileBtn').disabled = !enabled;
                            document.getElementById('discardBtn').disabled = !enabled;
                        }
                    });

                    resolve();
                });
            });
        }

        function detectLanguage(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const langMap = {
                'js': 'javascript', 'jsx': 'javascript', 'ts': 'typescript', 'tsx': 'typescript',
                'py': 'python', 'java': 'java', 'cpp': 'cpp', 'c': 'c', 'cs': 'csharp',
                'html': 'html', 'css': 'css', 'scss': 'scss', 'json': 'json',
                'md': 'markdown', 'xml': 'xml', 'yaml': 'yaml', 'yml': 'yaml',
                'sh': 'shell', 'bash': 'shell', 'sql': 'sql', 'go': 'go', 'rs': 'rust'
            };
            return langMap[ext] || 'plaintext';
        }

        async function saveFileChanges() {
            if (!currentFile || !userPermissions.canPush) {
                showToast('Cannot save: no push permissions', 'error');
                return;
            }

            const newContent = monacoEditor.getValue();
            const base64Content = btoa(unescape(encodeURIComponent(newContent)));

            currentFile.content = base64Content;
            currentFile.encoding = 'base64';
            currentFile.isDirty = true;

            await saveToIndexedDB('files', currentFile);

            document.getElementById('saveFileBtn').disabled = true;
            document.getElementById('discardBtn').disabled = true;
            
            await loadFileTree();
            showToast('Changes saved locally', 'success');
        }

        async function discardFileChanges() {
            if (!currentFile) return;
            
            const originalContent = currentFile.encoding === 'base64' ? atob(currentFile.content) : currentFile.content;
            monacoEditor.setValue(originalContent);
            
            document.getElementById('saveFileBtn').disabled = true;
            document.getElementById('discardBtn').disabled = true;
            
            showToast('Changes discarded', 'info');
        }

        // --- Source Control ---

        async function loadModifiedFilesList() {
            const dirtyFiles = await getDirtyFiles();
            const container = document.getElementById('modifiedFilesList');
            
            if (dirtyFiles.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-4">No modified files</div>';
                document.getElementById('commitButton').disabled = true;
                return;
            }

            container.innerHTML = dirtyFiles.map(file => `
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <i class="fas fa-file-code text-yellow-500"></i>
                    <span class="flex-1 font-mono text-sm">${file.path}</span>
                    <span class="text-xs text-yellow-600 font-medium">Modified</span>
                </div>
            `).join('');

            document.getElementById('commitButton').disabled = !userPermissions.canPush;
        }

        async function commitChanges() {
            const message = document.getElementById('commitMessage').value.trim();
            if (!message) {
                showToast('Please enter a commit message', 'warning');
                return;
            }

            if (!userPermissions.canPush) {
                showToast('You do not have push permissions', 'error');
                return;
            }

            showLoading('Committing changes...', 'Pushing to GitHub');

            try {
                const dirtyFiles = await getDirtyFiles();
                
                const gitConfig = await getFromIndexedDB('metadata', 'gitConfig');
                const author = {
                    name: gitConfig?.value?.name || 'Unknown',
                    email: gitConfig?.value?.email || 'unknown@example.com'
                };

                const refResponse = await githubFetch(`/repos/${currentRepo.owner}/${currentRepo.repo}/git/refs/heads/${currentRepo.branch}`);
                const latestCommitSha = refResponse.object.sha;

                const commitResponse = await githubFetch(`/repos/${currentRepo.owner}/${currentRepo.repo}/git/commits/${latestCommitSha}`);
                const baseTreeSha = commitResponse.tree.sha;

                const tree = dirtyFiles.map(file => ({
                    path: file.path,
                    mode: '100644',
                    type: 'blob',
                    content: file.encoding === 'base64' ? atob(file.content) : file.content
                }));

                const treeResponse = await githubFetch(`/repos/${currentRepo.owner}/${currentRepo.repo}/git/trees`, {
                    method: 'POST',
                    body: JSON.stringify({
                        base_tree: baseTreeSha,
                        tree: tree
                    })
                });

                const newCommit = await githubFetch(`/repos/${currentRepo.owner}/${currentRepo.repo}/git/commits`, {
                    method: 'POST',
                    body: JSON.stringify({
                        message: message,
                        tree: treeResponse.sha,
                        parents: [latestCommitSha],
                        author: author,
                        committer: author
                    })
                });

                await githubFetch(`/repos/${currentRepo.owner}/${currentRepo.repo}/git/refs/heads/${currentRepo.branch}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        sha: newCommit.sha
                    })
                });

                for (const file of dirtyFiles) {
                    file.isDirty = false;
                    await saveToIndexedDB('files', file);
                }

                document.getElementById('commitMessage').value = '';
                await loadModifiedFilesList();
                await loadFileTree();
                await loadCommits();
                
                showToast('Changes committed and pushed!', 'success');
                log(`âœ“ Committed: ${message}`);
            } catch (error) {
                showToast('Commit failed: ' + error.message, 'error');
                log(`âœ— Commit error: ${error.message}`, 'text-red-400');
            } finally {
                hideLoading();
            }
        }

        // --- Search ---

        async function searchFiles() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!query) {
                showToast('Enter a search query', 'warning');
                return;
            }

            showLoading('Searching...', 'Please wait');
            const resultsContainer = document.getElementById('searchResults');

            try {
                const files = await getAllFromIndexedDB('files');
                const results = [];

                for (const file of files) {
                    const content = file.encoding === 'base64' ? atob(file.content) : file.content;
                    const lines = content.split('\n');
                    
                    lines.forEach((line, index) => {
                        if (line.toLowerCase().includes(query)) {
                            results.push({
                                path: file.path,
                                line: index + 1,
                                content: line.trim()
                            });
                        }
                    });
                }

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="text-center text-gray-400 py-8">No results found</div>';
                } else {
                    resultsContainer.innerHTML = `
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Found ${results.length} results</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${results.slice(0, 100).map(r => `
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="text-xs text-gray-500 mb-1">${r.path}:${r.line}</div>
                                    <div class="font-mono text-sm">${r.content}</div>
                                </div>
                            `).join('')}
                            ${results.length > 100 ? '<div class="text-center text-sm text-gray-500 mt-4">Showing first 100 results</div>' : ''}
                        </div>
                    `;
                }
            } catch (error) {
                showToast('Search failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // --- Commits ---

        async function loadCommits() {
            try {
                const commits = await githubFetch(`/repos/${currentRepo.owner}/${currentRepo.repo}/commits?per_page=10`);
                const container = document.getElementById('commitsList');
                
                container.innerHTML = commits.map(c => `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-code-commit text-indigo-500 mt-1"></i>
                            <div class="flex-1">
                                <p class="font-medium text-gray-800">${c.commit.message}</p>
                                <p class="text-sm text-gray-500 mt-1">
                                    by ${c.commit.author.name} â€¢ ${new Date(c.commit.author.date).toLocaleString()}
                                </p>
                                <p class="text-xs text-gray-400 mt-1 font-mono">${c.sha.substring(0, 7)}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('commitsList').innerHTML = '<div class="text-center text-gray-400 py-8">Failed to load commits</div>';
            }
        }

        // --- Branches ---

        async function loadBranches() {
            try {
                const branches = await githubFetch(`/repos/${currentRepo.owner}/${currentRepo.repo}/branches`);
                const container = document.getElementById('branchesList');
                
                document.getElementById('statBranches').textContent = branches.length;
                
                container.innerHTML = branches.map(b => `
                    <div class="bg-gray-50 rounded-lg p-4 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-code-branch text-indigo-500"></i>
                            <span class="font-medium text-gray-800">${b.name}</span>
                            ${b.name === currentRepo.branch ? '<span class="bg-indigo-500 text-white text-xs px-2 py-1 rounded">Current</span>' : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('branchesList').innerHTML = '<div class="text-center text-gray-400 py-8">Failed to load branches</div>';
            }
        }

        // --- Download ZIP ---

        async function downloadAsZip() {
            if (typeof JSZip === 'undefined' || typeof saveAs === 'undefined') {
                showToast('Download libraries are missing', 'error');
                return;
            }
            showLoading('Creating ZIP...', 'This may take a moment');
            try {
                const files = await getAllFromIndexedDB('files');
                const zip = new JSZip();

                files.forEach(file => {
                    if (file.encoding === 'base64') {
                        zip.file(file.path, file.content, { base64: true });
                    }
                });

                const blob = await zip.generateAsync({ type: 'blob' });
                saveAs(blob, `${currentRepo.owner}-${currentRepo.repo}.zip`);
                showToast('ZIP downloaded successfully!', 'success');
                log(`âœ“ Downloaded ZIP: ${files.length} files`);
            } catch (error) {
                showToast('ZIP creation failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function saveSettings() {
            const userName = document.getElementById('gitUserName').value.trim();
            const userEmail = document.getElementById('gitUserEmail').value.trim();

            await saveToIndexedDB('metadata', {
                key: 'gitConfig',
                value: { name: userName, email: userEmail }
            });

            showToast('Settings saved', 'success');
        }

        async function showStorageInfo() {
            try {
                const files = await getAllFromIndexedDB('files');
                const metadata = await getAllFromIndexedDB('metadata');
                
                const totalSize = files.reduce((sum, f) => sum + (f.size || 0), 0);
                
                const info = document.getElementById('storageInfo');
                info.textContent = `
Files stored: ${files.length}
Metadata entries: ${metadata.length}
Total size: ${(totalSize / 1024 / 1024).toFixed(2)} MB
Database: IndexedDB v6
Authentication: ${userPermissions.authenticated ? 'Active' : 'Not active'}
                `;
            } catch (error) {
                document.getElementById('storageInfo').textContent = "Could not calculate storage info.";
            }
        }

        async function clearAllData() {
            if (!confirm('This will delete all cloned repositories and settings. Continue?')) {
                return;
            }
            showLoading('Clearing data...', 'Please wait');
            try {
                // Delete and recreate the database
                await new Promise((resolve, reject) => {
                    const deleteRequest = indexedDB.deleteDatabase('GitHubProDB');
                    deleteRequest.onsuccess = () => resolve();
                    deleteRequest.onerror = () => reject(deleteRequest.error);
                });
                location.reload();
            } catch (error) {
                showToast('Clear failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadRepoInfo() {
            const repoInfo = await getFromIndexedDB('metadata', 'repoInfo');
            if (!repoInfo) {
                document.getElementById('infoOutput').textContent = "No repository info found. Clone a repository first.";
                return;
            }
            const info = repoInfo.value;
            document.getElementById('infoOutput').textContent = `
Repository Information
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Name: ${info.name}
Full Name: ${info.full_name}
Description: ${info.description || 'N/A'}
Owner: ${info.owner.login}
Private: ${info.private ? 'Yes' : 'No'}
Default Branch: ${info.default_branch}

Created: ${new Date(info.created_at).toLocaleString()}
Updated: ${new Date(info.updated_at).toLocaleString()}
Pushed: ${new Date(info.pushed_at).toLocaleString()}

Stars: â­ ${info.stargazers_count}
Forks: ðŸ´ ${info.forks_count}
Watchers: ðŸ‘€ ${info.watchers_count}
Open Issues: ðŸ› ${info.open_issues_count}

Size: ${(info.size / 1024).toFixed(2)} MB
Language: ${info.language || 'N/A'}
License: ${info.license?.name || 'N/A'}

Homepage: ${info.homepage || 'N/A'}
Clone URL: ${info.clone_url}
            `;
        }

        // --- Initialize ---

        window.addEventListener('load', async () => {
            try {
                await initDB();
                log('âœ“ Database initialized (Version 6 - Clean)');
                
                await new Promise(resolve => setTimeout(resolve, 200));
                
                const savedRepo = await getFromIndexedDB('metadata', 'currentRepo');
                if (savedRepo) {
                    currentRepo = savedRepo.value;
                    document.getElementById('tokenInput').value = currentRepo.token || '';
                    document.getElementById('repoInput').value = `${currentRepo.owner}/${currentRepo.repo}`;
                    document.getElementById('branchSelect').innerHTML = `<option>${currentRepo.branch}</option>`;
                    
                    const savedPerms = await getFromIndexedDB('metadata', 'userPermissions');
                    if (savedPerms) {
                        userPermissions = savedPerms.value;
                        updatePermissionUI();
                    }
                    
                    await updateRepositoryUI();
                    await loadFileTree();
                    
                    log('âœ“ Loaded cached repository');
                } else {
                    switchView('repo');
                }

                const gitConfig = await getFromIndexedDB('metadata', 'gitConfig');
                if (gitConfig) {
                    document.getElementById('gitUserName').value = gitConfig.value.name;
                    document.getElementById('gitUserEmail').value = gitConfig.value.email;
                }

                await showStorageInfo();
                log('ðŸš€ GitHub Pro Client Ready!');
                
                initMonacoEditor().catch(error => {
                    console.error('Monaco editor failed to load', error);
                });
                
            } catch (error) {
                console.error('Initialization error:', error);
                log(`CRITICAL ERROR: ${error.message}`, 'text-red-400');
                showToast(`Initialization failed: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>