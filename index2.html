<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Text Summarizer with EntityDB RAG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .model-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .model-selector label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
        }
        
        select, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }
        
        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .model-info {
            margin-top: 10px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }
        
        .model-info strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }
        
        .model-info .badge {
            display: inline-block;
            padding: 3px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 5px;
            margin-top: 5px;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #218838;
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .output-box {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            min-height: 150px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .rag-results {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .generated-answer {
            font-size: 1.1em;
            line-height: 1.6;
            background: #e0f7fa;
            border-left: 4px solid #00acc1;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: #0c5460;
        }
        
        .rag-result-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .rag-result-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            border-left-width: 6px;
        }
        
        .rag-result-item strong {
            color: #667eea;
        }
        
        .similarity-score {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .status {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }
        
        .status.loading {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(0,0,0,.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spinner .6s linear infinite;
        }
        
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .history-list {
            list-style: none;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .history-item small {
            display: block;
            color: #666;
            margin-top: 8px;
            font-size: 0.85em;
        }
        
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            font-size: 12px;
            background: #dc3545;
            color: white;
        }
        
        .delete-btn:hover {
            background: #c82333;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: #999;
            width: auto;
            height: auto;
            padding: 0;
            line-height: 1;
            font-weight: 300;
        }
        
        .modal-close:hover {
            color: #333;
            background: none;
        }
        
        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .modal-metadata {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .modal-metadata p {
            margin: 5px 0;
            color: #666;
        }
        
        .modal-text {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            line-height: 1.6;
        }
        
        .modal-text h3 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        .search-info {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: #0d47a1;
        }
        
        .search-info strong {
            color: #1565c0;
        }
        
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #28a745;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: background 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ AI Text Summarizer with RAG </h1>
            <p>Powered by Transformers.js with Web Workers | No UI freezing!</p>
        </header>
        
        <div class="main-content">
            <!-- Summarization Model Selection Section -->
            <div class="full-width">
                <div class="section">
                    <h2>üìù Summarization Model</h2>
                    <div class="model-selector">
                        <label for="summarization-model">Select Summarization Model:</label>
                        <select id="summarization-model">
                            <optgroup label="Abstractive Summarization (Recommended)">
                                <option value="Xenova/distilbart-cnn-6-6">DistilBART CNN (Fast, Balanced)</option>
                                <option value="Xenova/bart-large-cnn">BART Large CNN (High Quality)</option>
                                <option value="Xenova/distilbart-cnn-12-6">DistilBART 12-6 (Accurate)</option>
                            </optgroup>
                            <optgroup label="Specialized Models">
                                <option value="Xenova/long-t5-tglobal-base-16384-book-summary">Long-T5 Books (Long texts)</option>
                                <option value="Xenova/flan-t5-small">FLAN-T5 Small (Efficient)</option>
                                <option value="Xenova/flan-t5-base">FLAN-T5 Base (Versatile)</option>
                            </optgroup>
                        </select>
                        <div id="summarization-model-info" class="model-info">Loading model information...</div>
                    </div>
                </div>
                
                <div id="status" class="status loading">
                    <span class="loading-spinner"></span> Initializing Web Worker and loading AI models... Please wait.
                </div>
            </div>
            
            <!-- Input Section -->
            <div class="section">
                <h2>üìù Input Text</h2>
                <textarea id="input-text" rows="12" placeholder="Paste your text here for summarization..."></textarea>
                <div class="button-group">
                    <button id="summarize-btn" class="btn-primary" disabled>‚ú® Summarize</button>
                    <button id="sample-btn" class="btn-secondary">üìÑ Load Sample</button>
                    <button id="clear-btn" class="btn-secondary">üóëÔ∏è Clear</button>
                </div>
            </div>
            
            <!-- Output Section -->
            <div class="section">
                <h2>üìÑ Summary Output</h2>
                <div id="output" class="output-box">Your summary will appear here...</div>
                <div class="button-group">
                    <button id="save-btn" class="btn-success" disabled>üíæ Save to EntityDB</button>
                    <button id="copy-btn" class="btn-secondary" disabled>üìã Copy Summary</button>
                </div>
            </div>
            
            <!-- Q&A Model Selection + RAG Search Section -->
            <div class="full-width">
                <div class="section">
                    <h2>üîç Semantic Search & RAG Question Answering</h2>
                    
                    <!-- Q&A Model Selector -->
                    <div class="model-selector" style="margin-bottom: 20px;">
                        <label for="qa-model">üí¨ Question Answering Model:</label>
                        <select id="qa-model">
                            <optgroup label="General Q&A Models">
                                <option value="Xenova/distilbert-base-cased-distilled-squad">DistilBERT SQuAD (Fast)</option>
                                <option value="Xenova/bert-base-multilingual-cased-squad2">BERT Multilingual (Multi-lang)</option>
                            </optgroup>
                            <optgroup label="Code & Technical Q&A">
                                <option value="Xenova/distilroberta-base">DistilRoBERTa (Code-aware)</option>
                                <option value="Xenova/roberta-base-squad2">RoBERTa SQuAD2 (Technical)</option>
                            </optgroup>
                            <optgroup label="Advanced Models">
                                <option value="Xenova/longformer-base-4096-finetuned-squadv2">Longformer (Long context)</option>
                                <option value="Xenova/deberta-v3-small-squad2">DeBERTa (Accurate)</option>
                            </optgroup>
                        </select>
                        <div id="qa-model-info" class="model-info">Loading model information...</div>
                    </div>
                    
                    <!-- Search Input -->
                    <input type="text" id="rag-query" placeholder="Ask a question about your saved documents..." />
                    <div class="button-group">
                        <button id="rag-search-btn" class="btn-primary" disabled>ü§ñ Search & Answer</button>
                    </div>
                    <div id="rag-results" style="display: none;"></div>
                </div>
            </div>
            
            <!-- History Section -->
            <div class="section">
                <h2>üìö Saved History</h2>
                <ul id="history-list" class="history-list"></ul>
                <div class="button-group">
                    <button id="load-history-btn" class="btn-secondary">üîÑ Refresh</button>
                    <button id="clear-history-btn" class="btn-secondary">üóëÔ∏è Clear All</button>
                    <button id="export-btn" class="btn-secondary">üì• Export Data</button>
                </div>
            </div>
            
            <!-- Stats Section -->
            <div class="section">
                <h2>üìä Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="total-summaries">0</h3>
                        <p>Total Summaries</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="total-vectors">0</h3>
                        <p>Vector Embeddings</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="avg-compression">0%</h3>
                        <p>Avg Compression</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for document details -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <div class="sync-indicator" id="sync-indicator"></div>
    
    <script type="module">
        // Model descriptions with detailed information
        const summarizationModelDescriptions = {
            'Xenova/distilbart-cnn-6-6': {
                name: 'DistilBART CNN 6-6',
                description: 'Distilled version of BART, optimized for speed while maintaining quality. Great for news articles and general text.',
                size: '~300MB',
                speed: 'Fast',
                quality: 'Good',
                specialty: 'General purpose, balanced performance'
            },
            'Xenova/bart-large-cnn': {
                name: 'BART Large CNN',
                description: 'Full-size BART model trained on CNN/DailyMail dataset. Produces high-quality abstractive summaries.',
                size: '~1.6GB',
                speed: 'Slower',
                quality: 'Excellent',
                specialty: 'News articles, long documents'
            },
            'Xenova/distilbart-cnn-12-6': {
                name: 'DistilBART CNN 12-6',
                description: 'Larger distilled BART with 12 encoder layers. Better accuracy than 6-6 variant.',
                size: '~450MB',
                speed: 'Moderate',
                quality: 'Very Good',
                specialty: 'Higher accuracy, moderate speed'
            },
            'Xenova/long-t5-tglobal-base-16384-book-summary': {
                name: 'Long-T5 Book Summary',
                description: 'Specifically designed for very long documents (up to 16K tokens). Excellent for books and lengthy reports.',
                size: '~950MB',
                speed: 'Slow',
                quality: 'Excellent',
                specialty: 'Long documents, books, research papers'
            },
            'Xenova/flan-t5-small': {
                name: 'FLAN-T5 Small',
                description: 'Instruction-tuned T5 model. Very efficient and versatile for various summarization tasks.',
                size: '~240MB',
                speed: 'Very Fast',
                quality: 'Good',
                specialty: 'Quick summaries, low resource usage'
            },
            'Xenova/flan-t5-base': {
                name: 'FLAN-T5 Base',
                description: 'Larger FLAN-T5 with better understanding. Balanced between speed and quality.',
                size: '~890MB',
                speed: 'Moderate',
                quality: 'Very Good',
                specialty: 'Versatile, instruction-following'
            }
        };
        
        const qaModelDescriptions = {
            'Xenova/distilbert-base-cased-distilled-squad': {
                name: 'DistilBERT SQuAD',
                description: 'Lightweight and fast Q&A model. Great for quick answers from your documents.',
                size: '~260MB',
                speed: 'Very Fast',
                quality: 'Good',
                specialty: 'General Q&A, fast responses'
            },
            'Xenova/bert-base-multilingual-cased-squad2': {
                name: 'BERT Multilingual',
                description: 'Supports 104 languages. Perfect if your documents are in multiple languages.',
                size: '~710MB',
                speed: 'Moderate',
                quality: 'Very Good',
                specialty: 'Multilingual support, diverse content'
            },
            'Xenova/distilroberta-base': {
                name: 'DistilRoBERTa Base',
                description: 'Optimized for technical and code-related content. Better understanding of structured text.',
                size: '~330MB',
                speed: 'Fast',
                quality: 'Very Good',
                specialty: 'Code, technical documentation'
            },
            'Xenova/roberta-base-squad2': {
                name: 'RoBERTa SQuAD2',
                description: 'Enhanced BERT variant with better performance on technical questions and edge cases.',
                size: '~480MB',
                speed: 'Moderate',
                quality: 'Excellent',
                specialty: 'Technical Q&A, complex queries'
            },
            'Xenova/longformer-base-4096-finetuned-squadv2': {
                name: 'Longformer SQuAD',
                description: 'Handles very long contexts (4096 tokens). Ideal for finding answers in lengthy documents.',
                size: '~550MB',
                speed: 'Slow',
                quality: 'Excellent',
                specialty: 'Long documents, complex context'
            },
            'Xenova/deberta-v3-small-squad2': {
                name: 'DeBERTa v3 Small',
                description: 'State-of-the-art architecture with disentangled attention. Very accurate for complex questions.',
                size: '~540MB',
                speed: 'Moderate',
                quality: 'Excellent',
                specialty: 'High accuracy, complex reasoning'
            }
        };
        
        function formatModelInfo(modelData) {
            return `
                <strong>${modelData.name}</strong>
                <div>${modelData.description}</div>
                <div style="margin-top: 8px;">
                    <span class="badge">Size: ${modelData.size}</span>
                    <span class="badge">Speed: ${modelData.speed}</span>
                    <span class="badge">Quality: ${modelData.quality}</span>
                </div>
                <div style="margin-top: 5px; font-style: italic; color: #888;">
                    üí° ${modelData.specialty}
                </div>
            `;
        }
        
        // EntityDB Implementation
        class EntityDB {
            constructor(dbName = 'EntityDB', version = 1) {
                this.dbName = dbName;
                this.version = version;
                this.db = null;
            }
            
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        if (!db.objectStoreNames.contains('entities')) {
                            const entityStore = db.createObjectStore('entities', { keyPath: 'id' });
                            entityStore.createIndex('type', 'type', { unique: false });
                            entityStore.createIndex('createdAt', 'createdAt', { unique: false });
                        }
                        
                        if (!db.objectStoreNames.contains('vectors')) {
                            const vectorStore = db.createObjectStore('vectors', { keyPath: 'id' });
                            vectorStore.createIndex('entityId', 'entityId', { unique: false });
                        }
                    };
                });
            }
            
            async addEntity(type, data, metadata = {}) {
                const entity = {
                    id: `${type}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    type,
                    data,
                    metadata,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                const transaction = this.db.transaction(['entities'], 'readwrite');
                const store = transaction.objectStore('entities');
                await store.add(entity);
                
                return entity;
            }
            
            async addVector(entityId, vector, metadata = {}) {
                const vectorEntry = {
                    id: `vec_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    entityId,
                    vector,
                    metadata,
                    createdAt: new Date().toISOString()
                };
                
                const transaction = this.db.transaction(['vectors'], 'readwrite');
                const store = transaction.objectStore('vectors');
                await store.add(vectorEntry);
                
                return vectorEntry;
            }
            
            async getEntity(id) {
                const transaction = this.db.transaction(['entities'], 'readonly');
                const store = transaction.objectStore('entities');
                return new Promise((resolve, reject) => {
                    const request = store.get(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            async getAllEntities(type = null) {
                const transaction = this.db.transaction(['entities'], 'readonly');
                const store = transaction.objectStore('entities');
                
                return new Promise((resolve, reject) => {
                    const request = type ? store.index('type').getAll(type) : store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            async getAllVectors() {
                const transaction = this.db.transaction(['vectors'], 'readonly');
                const store = transaction.objectStore('vectors');
                
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            cosineSimilarity(a, b) {
                const dotProduct = a.reduce((sum, val, i) => sum + val * b[i], 0);
                const magnitudeA = Math.sqrt(a.reduce((sum, val) => sum + val * val, 0));
                const magnitudeB = Math.sqrt(b.reduce((sum, val) => sum + val * val, 0));
                return dotProduct / (magnitudeA * magnitudeB);
            }
            
            async semanticSearch(queryVector, topK = 5) {
                const vectors = await this.getAllVectors();
                const similarities = vectors.map(vec => ({
                    entityId: vec.entityId,
                    similarity: this.cosineSimilarity(queryVector, vec.vector),
                    vectorId: vec.id
                }));
                
                similarities.sort((a, b) => b.similarity - a.similarity);
                return similarities.slice(0, topK);
            }
            
            async deleteEntity(id) {
                const transaction = this.db.transaction(['entities', 'vectors'], 'readwrite');
                
                await transaction.objectStore('entities').delete(id);
                
                const vectorStore = transaction.objectStore('vectors');
                const index = vectorStore.index('entityId');
                const vectors = await new Promise((resolve, reject) => {
                    const request = index.getAll(id);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
                
                for (const vec of vectors) {
                    await vectorStore.delete(vec.id);
                }
            }
            
            async clearAll() {
                const transaction = this.db.transaction(['entities', 'vectors'], 'readwrite');
                await transaction.objectStore('entities').clear();
                await transaction.objectStore('vectors').clear();
            }
        }
        
        // Initialize EntityDB
        const db = new EntityDB();
        await db.init();
        
        // Initialize Web Worker
        const worker = new Worker(new URL('ai-worker.js', import.meta.url), { type: 'module' });
        
        // Current models
        let currentSummarizationModel = 'Xenova/distilbart-cnn-6-6';
        let currentQAModel = 'Xenova/distilbert-base-cased-distilled-squad';
        
        // DOM elements
        const summarizationModelSelect = document.getElementById('summarization-model');
        const qaModelSelect = document.getElementById('qa-model');
        const summarizationModelInfo = document.getElementById('summarization-model-info');
        const qaModelInfo = document.getElementById('qa-model-info');
        const statusEl = document.getElementById('status');
        const inputText = document.getElementById('input-text');
        const outputEl = document.getElementById('output');
        const summarizeBtn = document.getElementById('summarize-btn');
        const clearBtn = document.getElementById('clear-btn');
        const sampleBtn = document.getElementById('sample-btn');
        const saveBtn = document.getElementById('save-btn');
        const copyBtn = document.getElementById('copy-btn');
        const ragQuery = document.getElementById('rag-query');
        const ragSearchBtn = document.getElementById('rag-search-btn');
        const ragResults = document.getElementById('rag-results');
        const historyList = document.getElementById('history-list');
        const loadHistoryBtn = document.getElementById('load-history-btn');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const exportBtn = document.getElementById('export-btn');
        const totalSummariesEl = document.getElementById('total-summaries');
        const totalVectorsEl = document.getElementById('total-vectors');
        const avgCompressionEl = document.getElementById('avg-compression');
        const modalOverlay = document.getElementById('modal-overlay');
        const syncIndicator = document.getElementById('sync-indicator');
        
        // BroadcastChannel for cross-tab sync
        let broadcastChannel = null;
        try {
            broadcastChannel = new BroadcastChannel('entitydb-sync');
        } catch (e) {
            console.warn('BroadcastChannel not supported');
        }
        
        let currentSearchQuery = '';
        let currentSummary = '';
        
        // Update model info displays
        function updateModelInfo() {
            const sumModelData = summarizationModelDescriptions[currentSummarizationModel];
            const qaModelData = qaModelDescriptions[currentQAModel];
            
            summarizationModelInfo.innerHTML = formatModelInfo(sumModelData);
            qaModelInfo.innerHTML = formatModelInfo(qaModelData);
        }
        
        // Handle worker messages
        worker.onmessage = function(e) {
            const { type, message, error, summary, embedding, answer, modelType, model } = e.data;
            
            switch(type) {
                case 'INIT_PROGRESS':
                    statusEl.className = 'status loading';
                    statusEl.innerHTML = `<span class="loading-spinner"></span> ${message}`;
                    break;
                    
                case 'INIT_COMPLETE':
                    statusEl.className = 'status ready';
                    statusEl.textContent = '‚úÖ All models loaded successfully! UI remains responsive.';
                    summarizeBtn.disabled = false;
                    ragSearchBtn.disabled = false;
                    break;
                    
                case 'SUMMARIZE_PROGRESS':
                    // UI stays responsive during this!
                    break;
                    
                case 'SUMMARIZE_COMPLETE':
                    currentSummary = summary;
                    outputEl.textContent = summary;
                    saveBtn.disabled = false;
                    copyBtn.disabled = false;
                    summarizeBtn.disabled = false;
                    summarizeBtn.textContent = '‚ú® Summarize';
                    break;
                    
                case 'EMBEDDING_COMPLETE':
                    handleEmbeddingComplete(embedding);
                    break;
                    
                case 'QA_COMPLETE':
                    handleQAComplete(answer);
                    break;
                    
                case 'MODEL_SWITCH_PROGRESS':
                    statusEl.className = 'status loading';
                    statusEl.innerHTML = `<span class="loading-spinner"></span> ${message}`;
                    break;
                    
                case 'MODEL_SWITCH_COMPLETE':
                    statusEl.className = 'status ready';
                    statusEl.textContent = `‚úÖ ${modelType === 'summarization' ? 'Summarization' : 'Q&A'} model updated successfully!`;
                    if (modelType === 'summarization') {
                        summarizeBtn.disabled = false;
                    } else {
                        ragSearchBtn.disabled = false;
                    }
                    break;
                    
                case 'ERROR':
                    statusEl.className = 'status error';
                    statusEl.textContent = '‚ùå Error: ' + error;
                    console.error('Worker error:', error);
                    summarizeBtn.disabled = false;
                    ragSearchBtn.disabled = false;
                    summarizeBtn.textContent = '‚ú® Summarize';
                    ragSearchBtn.textContent = 'ü§ñ Search & Answer';
                    break;
            }
        };
        
        // Initialize
        async function init() {
            updateModelInfo();
            
            // Initialize worker with models
            worker.postMessage({
                type: 'INIT_MODELS',
                data: {
                    summarizationModel: currentSummarizationModel,
                    qaModel: currentQAModel
                }
            });
            
            await loadHistory();
            await updateStats();
        }
        
        // Summarize text
        function summarizeText() {
            const text = inputText.value.trim();
            if (!text) {
                alert('Please enter some text to summarize.');
                return;
            }
            
            summarizeBtn.disabled = true;
            summarizeBtn.innerHTML = '<span class="loading-spinner"></span> Summarizing...';
            outputEl.textContent = 'Generating summary...';
            
            // Send to worker - UI stays responsive!
            worker.postMessage({
                type: 'SUMMARIZE',
                data: { text }
            });
        }
        
        // Save to EntityDB
        let savingEntity = null;
        
        async function saveToEntityDB() {
            const originalText = inputText.value.trim();
            const summary = currentSummary;
            
            if (!originalText || !summary || summary === 'Your summary will appear here...') {
                alert('Please generate a summary first.');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="loading-spinner"></span> Saving...';
            
            const compressionRatio = ((1 - summary.length / originalText.length) * 100).toFixed(1);
            
            // Create entity first
            savingEntity = await db.addEntity('summary', {
                originalText: originalText,
                summary: summary,
                compressionRatio: parseFloat(compressionRatio),
                summarizationModel: currentSummarizationModel
            });
            
            // Generate embedding in worker
            worker.postMessage({
                type: 'GENERATE_EMBEDDING',
                data: { text: originalText }
            });
        }
        
        async function handleEmbeddingComplete(embedding) {
            if (savingEntity) {
                await db.addVector(savingEntity.id, embedding, {
                    textLength: savingEntity.data.originalText.length,
                    summaryLength: savingEntity.data.summary.length
                });
                
                if (broadcastChannel) {
                    broadcastChannel.postMessage({ type: 'DB_UPDATE' });
                }
                
                await loadHistory();
                await updateStats();
                
                saveBtn.textContent = '‚úì Saved!';
                setTimeout(() => {
                    saveBtn.textContent = 'üíæ Save to EntityDB';
                    saveBtn.disabled = false;
                }, 2000);
                
                savingEntity = null;
            }
        }
        
        // Helper function to highlight search terms
        function highlightSearchTerms(text, searchQuery) {
            if (!searchQuery) return text;
            
            const searchWords = searchQuery.toLowerCase().split(/\s+/).filter(w => w.length > 2);
            
            let highlightedText = text;
            searchWords.forEach(word => {
                const regex = new RegExp(`\\b(${word}\\w*)`, 'gi');
                highlightedText = highlightedText.replace(regex, '<span class="highlight">$1</span>');
            });
            
            return highlightedText;
        }
        
        // Modal functions
        function showDocumentModal(entity, similarity, searchQuery = '') {
            const modalBody = document.getElementById('modal-body');
            
            const highlightedOriginal = highlightSearchTerms(entity.data.originalText, searchQuery);
            const highlightedSummary = highlightSearchTerms(entity.data.summary, searchQuery);
            
            const searchWords = searchQuery ? searchQuery.split(/\s+/).filter(w => w.length > 2) : [];
            const searchWordsDisplay = searchWords.length > 0 
                ? `<div class="search-info"><strong>üîç Highlighted search terms:</strong> ${searchWords.map(w => `<span class="highlight">${w}</span>`).join(', ')}</div>`
                : '';
            
            modalBody.innerHTML = `
                <h2>üìÑ Document Details</h2>
                ${searchWordsDisplay}
                <div class="modal-metadata">
                    <p><strong>Created:</strong> ${new Date(entity.createdAt).toLocaleString()}</p>
                    <p><strong>Similarity Score:</strong> ${(similarity * 100).toFixed(1)}%</p>
                    <p><strong>Compression:</strong> ${entity.data.compressionRatio}%</p>
                    <p><strong>Model Used:</strong> ${entity.data.summarizationModel}</p>
                </div>
                <div class="modal-text">
                    <h3>Summary:</h3>
                    <p>${highlightedSummary}</p>
                    <h3>Original Text:</h3>
                    <p>${highlightedOriginal}</p>
                </div>
            `;
            
            modalOverlay.classList.add('active');
        }
        
        window.closeModal = function() {
            modalOverlay.classList.remove('active');
        };
        
        // RAG Search
        let ragSearchResults = [];
        
        async function performRAGSearch() {
            const query = ragQuery.value.trim();
            if (!query) {
                alert('Please enter a search query.');
                return;
            }
            
            currentSearchQuery = query;
            
            ragSearchBtn.disabled = true;
            ragSearchBtn.innerHTML = '<span class="loading-spinner"></span> Searching...';
            ragResults.style.display = 'block';
            ragResults.innerHTML = '<div class="rag-results">Searching for relevant documents...</div>';
            
            // Generate query embedding in worker
            worker.postMessage({
                type: 'GENERATE_EMBEDDING',
                data: { text: query }
            });
            
            // Wait for embedding and then search
            const checkEmbedding = setInterval(async () => {
                // This will be handled by handleQASearchEmbedding
            }, 100);
        }
        
        let qaQueryEmbedding = null;
        
        worker.addEventListener('message', async function(e) {
            if (e.data.type === 'EMBEDDING_COMPLETE' && !savingEntity) {
                // This is for RAG search
                qaQueryEmbedding = e.data.embedding;
                await performRAGSearchWithEmbedding();
            }
        });
        
        async function performRAGSearchWithEmbedding() {
            if (!qaQueryEmbedding) return;
            
            const searchResults = await db.semanticSearch(qaQueryEmbedding, 3);
            
            if (searchResults.length === 0) {
                ragResults.innerHTML = '<div class="rag-results">No relevant documents found in your history.</div>';
                ragSearchBtn.disabled = false;
                ragSearchBtn.textContent = 'ü§ñ Search & Answer';
                qaQueryEmbedding = null;
                return;
            }
            
            ragResults.innerHTML = '<div class="rag-results">Found documents, generating answer...</div>';
            let contextPieces = [];
            let sourceHtml = '<h4>üìö Sources Used (Click to view):</h4>';
            
            ragSearchResults = searchResults;
            
            for (const result of searchResults) {
                const entity = await db.getEntity(result.entityId);
                if (entity) {
                    contextPieces.push(entity.data.originalText);
                    
                    sourceHtml += `
                        <div class="rag-result-item" onclick="window.showResult('${entity.id}', ${result.similarity})">
                            <strong>Source:</strong> ${entity.data.summary.substring(0, 100)}...
                            <span class="similarity-score">${(result.similarity * 100).toFixed(1)}% match</span>
                        </div>
                    `;
                }
            }
            
            const context = contextPieces.join('\n\n');
            
            // Store source HTML for later
            window.ragSourceHtml = sourceHtml;
            
            // Send to worker for answer
            worker.postMessage({
                type: 'ANSWER_QUESTION',
                data: {
                    query: currentSearchQuery,
                    context: context
                }
            });
            
            qaQueryEmbedding = null;
        }
        
        function handleQAComplete(answer) {
            const finalAnswer = answer || 'Could not find a specific answer in the provided documents.';
            const sanitizedAnswer = finalAnswer.replace(/</g, "&lt;").replace(/>/g, "&gt;");

            let html = `
                <div class="rag-results">
                    <h3>ü§ñ Generated Answer:</h3>
                    <p class="generated-answer">${sanitizedAnswer}</p>
                    <p style="font-size: 0.9em; color: #666; font-style: italic;">
                        Generated using: ${qaModelDescriptions[currentQAModel].name}
                    </p>
                    <hr style="margin: 15px 0;">
                    ${window.ragSourceHtml || ''}
                </div>
            `;
            ragResults.innerHTML = html;
            
            ragSearchBtn.disabled = false;
            ragSearchBtn.textContent = 'ü§ñ Search & Answer';
        }
        
        // Show result in modal
        window.showResult = async function(entityId, similarity) {
            const entity = await db.getEntity(entityId);
            if (entity) {
                showDocumentModal(entity, similarity, currentSearchQuery);
            }
        };
        
        // Load history
        async function loadHistory() {
            const entities = await db.getAllEntities('summary');
            historyList.innerHTML = '';
            
            if (entities.length === 0) {
                historyList.innerHTML = '<li class="history-item">No summaries yet!</li>';
                return;
            }
            
            entities.reverse().forEach(entity => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `
                    <strong>Summary:</strong> ${entity.data.summary.substring(0, 100)}...
                    <small>Created: ${new Date(entity.createdAt).toLocaleString()} | 
                    Compression: ${entity.data.compressionRatio}%</small>
                    <button class="delete-btn" onclick="window.deleteItem('${entity.id}')">Delete</button>
                `;
                li.onclick = (e) => {
                    if (!e.target.classList.contains('delete-btn')) {
                        inputText.value = entity.data.originalText;
                        outputEl.textContent = entity.data.summary;
                        currentSummary = entity.data.summary;
                        saveBtn.disabled = false;
                        copyBtn.disabled = false;
                    }
                };
                historyList.appendChild(li);
            });
        }
        
        window.deleteItem = async (id) => {
            if (confirm('Delete this summary?')) {
                await db.deleteEntity(id);
                await loadHistory();
                await updateStats();
            }
        };
        
        async function clearHistory() {
            if (confirm('Clear all data?')) {
                await db.clearAll();
                await loadHistory();
                await updateStats();
            }
        }
        
        async function exportData() {
            const entities = await db.getAllEntities();
            const vectors = await db.getAllVectors();
            const data = { entities, vectors };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `entitydb-export-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function updateStats() {
            const entities = await db.getAllEntities('summary');
            const vectors = await db.getAllVectors();
            
            totalSummariesEl.textContent = entities.length;
            totalVectorsEl.textContent = vectors.length;
            
            if (entities.length > 0) {
                const avg = entities.reduce((sum, e) => sum + e.data.compressionRatio, 0) / entities.length;
                avgCompressionEl.textContent = avg.toFixed(1) + '%';
            } else {
                avgCompressionEl.textContent = '0%';
            }
        }
        
        function loadSampleText() {
            inputText.value = `Agile software development is an iterative approach to project management and software development that helps teams deliver value to their customers faster and with fewer headaches. Instead of betting everything on a "big bang" launch, an agile team delivers work in small, but consumable, increments. Requirements, plans, and results are evaluated continuously so teams have a natural mechanism for responding to change quickly. Scrum is a framework for agile project management that emphasizes teamwork, accountability and iterative progress toward a well-defined goal. The framework begins with a simple premise: Start with what can be seen or known. After that, track the progress and tweak as necessary. Scrum ceremonies include Sprint Planning, Daily Scrum, Sprint Review, and Sprint Retrospective.`;
        }
        
        // BroadcastChannel sync
        if (broadcastChannel) {
            broadcastChannel.onmessage = async (event) => {
                if (event.data.type === 'DB_UPDATE') {
                    await loadHistory();
                    await updateStats();
                    syncIndicator.style.background = '#ffc107';
                    setTimeout(() => { syncIndicator.style.background = '#28a745'; }, 500);
                }
            };
        }
        
        // Event listeners
        summarizeBtn.addEventListener('click', summarizeText);
        clearBtn.addEventListener('click', () => {
            inputText.value = '';
            outputEl.textContent = 'Your summary will appear here...';
            currentSummary = '';
            saveBtn.disabled = true;
            copyBtn.disabled = true;
        });
        sampleBtn.addEventListener('click', loadSampleText);
        saveBtn.addEventListener('click', saveToEntityDB);
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(outputEl.textContent);
            copyBtn.textContent = '‚úì Copied!';
            setTimeout(() => { copyBtn.textContent = 'üìã Copy Summary'; }, 2000);
        });
        ragSearchBtn.addEventListener('click', performRAGSearch);
        loadHistoryBtn.addEventListener('click', loadHistory);
        clearHistoryBtn.addEventListener('click', clearHistory);
        exportBtn.addEventListener('click', exportData);
        
        // Summarization model change
        summarizationModelSelect.addEventListener('change', (e) => {
            const model = e.target.value;
            const modelData = summarizationModelDescriptions[model];
            
            if (confirm(`Switch to ${modelData.name}?\n\nSize: ${modelData.size}\nSpeed: ${modelData.speed}\nQuality: ${modelData.quality}\n\nThis will reload the summarization model.`)) {
                currentSummarizationModel = model;
                summarizeBtn.disabled = true;
                updateModelInfo();
                
                worker.postMessage({
                    type: 'SWITCH_SUMMARIZATION_MODEL',
                    data: { model }
                });
            } else {
                summarizationModelSelect.value = currentSummarizationModel;
            }
        });
        
        // Q&A model change
        qaModelSelect.addEventListener('change', (e) => {
            const model = e.target.value;
            const modelData = qaModelDescriptions[model];
            
            if (confirm(`Switch to ${modelData.name}?\n\nSize: ${modelData.size}\nSpeed: ${modelData.speed}\nQuality: ${modelData.quality}\n\nThis will reload the Q&A model.`)) {
                currentQAModel = model;
                ragSearchBtn.disabled = true;
                updateModelInfo();
                
                worker.postMessage({
                    type: 'SWITCH_QA_MODEL',
                    data: { model }
                });
            } else {
                qaModelSelect.value = currentQAModel;
            }
        });
        
        // Keyboard shortcut to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
                closeModal();
            }
        });
        
        // Start initialization
        init();
        
        // Make DB accessible in console
        window.db = db;
    </script>
</body>
</html>

